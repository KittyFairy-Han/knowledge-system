<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VuePress</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="image/logo.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/knowledge-system/assets/css/0.styles.c0d58452.css" as="style"><link rel="preload" href="/knowledge-system/assets/js/app.efb8a36c.js" as="script"><link rel="preload" href="/knowledge-system/assets/js/2.380f0438.js" as="script"><link rel="preload" href="/knowledge-system/assets/js/4.17cbc09c.js" as="script"><link rel="prefetch" href="/knowledge-system/assets/js/10.0b2060dd.js"><link rel="prefetch" href="/knowledge-system/assets/js/11.bf088a55.js"><link rel="prefetch" href="/knowledge-system/assets/js/12.daee262f.js"><link rel="prefetch" href="/knowledge-system/assets/js/13.3893f6de.js"><link rel="prefetch" href="/knowledge-system/assets/js/14.9ee4bb24.js"><link rel="prefetch" href="/knowledge-system/assets/js/15.f52d4b2f.js"><link rel="prefetch" href="/knowledge-system/assets/js/16.629eae83.js"><link rel="prefetch" href="/knowledge-system/assets/js/17.f2ca733b.js"><link rel="prefetch" href="/knowledge-system/assets/js/18.2609bc7a.js"><link rel="prefetch" href="/knowledge-system/assets/js/19.722c12ae.js"><link rel="prefetch" href="/knowledge-system/assets/js/20.04c5c8f5.js"><link rel="prefetch" href="/knowledge-system/assets/js/21.7255bbf3.js"><link rel="prefetch" href="/knowledge-system/assets/js/22.74f6f4eb.js"><link rel="prefetch" href="/knowledge-system/assets/js/23.76511911.js"><link rel="prefetch" href="/knowledge-system/assets/js/24.c50a706f.js"><link rel="prefetch" href="/knowledge-system/assets/js/25.78533074.js"><link rel="prefetch" href="/knowledge-system/assets/js/26.79a0f9a7.js"><link rel="prefetch" href="/knowledge-system/assets/js/27.f0dff8d0.js"><link rel="prefetch" href="/knowledge-system/assets/js/28.afb408c0.js"><link rel="prefetch" href="/knowledge-system/assets/js/29.613f087f.js"><link rel="prefetch" href="/knowledge-system/assets/js/3.cdb9a6b7.js"><link rel="prefetch" href="/knowledge-system/assets/js/30.2b8a8360.js"><link rel="prefetch" href="/knowledge-system/assets/js/31.0e67c3fd.js"><link rel="prefetch" href="/knowledge-system/assets/js/32.b6de32ef.js"><link rel="prefetch" href="/knowledge-system/assets/js/33.48608e22.js"><link rel="prefetch" href="/knowledge-system/assets/js/34.b84be050.js"><link rel="prefetch" href="/knowledge-system/assets/js/35.09152745.js"><link rel="prefetch" href="/knowledge-system/assets/js/36.ff9d75aa.js"><link rel="prefetch" href="/knowledge-system/assets/js/37.ef07487a.js"><link rel="prefetch" href="/knowledge-system/assets/js/38.d69a69e6.js"><link rel="prefetch" href="/knowledge-system/assets/js/39.68e5d946.js"><link rel="prefetch" href="/knowledge-system/assets/js/40.2cecfb8f.js"><link rel="prefetch" href="/knowledge-system/assets/js/41.67191ecb.js"><link rel="prefetch" href="/knowledge-system/assets/js/42.f32507f7.js"><link rel="prefetch" href="/knowledge-system/assets/js/43.81a1a007.js"><link rel="prefetch" href="/knowledge-system/assets/js/44.3527553c.js"><link rel="prefetch" href="/knowledge-system/assets/js/45.4c1985e1.js"><link rel="prefetch" href="/knowledge-system/assets/js/46.b9d335d7.js"><link rel="prefetch" href="/knowledge-system/assets/js/47.15a57b82.js"><link rel="prefetch" href="/knowledge-system/assets/js/48.c7f8116e.js"><link rel="prefetch" href="/knowledge-system/assets/js/49.cb3a47c3.js"><link rel="prefetch" href="/knowledge-system/assets/js/5.0ab3a2e5.js"><link rel="prefetch" href="/knowledge-system/assets/js/50.09658262.js"><link rel="prefetch" href="/knowledge-system/assets/js/51.40168b15.js"><link rel="prefetch" href="/knowledge-system/assets/js/52.a84fa260.js"><link rel="prefetch" href="/knowledge-system/assets/js/53.8787c135.js"><link rel="prefetch" href="/knowledge-system/assets/js/54.0f4763ce.js"><link rel="prefetch" href="/knowledge-system/assets/js/55.27b494a1.js"><link rel="prefetch" href="/knowledge-system/assets/js/56.d40a60ea.js"><link rel="prefetch" href="/knowledge-system/assets/js/57.cccba3b5.js"><link rel="prefetch" href="/knowledge-system/assets/js/58.589ae661.js"><link rel="prefetch" href="/knowledge-system/assets/js/59.f9f1bc97.js"><link rel="prefetch" href="/knowledge-system/assets/js/6.88f5da7c.js"><link rel="prefetch" href="/knowledge-system/assets/js/60.314dc9e5.js"><link rel="prefetch" href="/knowledge-system/assets/js/61.9abacf7e.js"><link rel="prefetch" href="/knowledge-system/assets/js/62.ca0bb032.js"><link rel="prefetch" href="/knowledge-system/assets/js/63.231b732e.js"><link rel="prefetch" href="/knowledge-system/assets/js/64.f973e823.js"><link rel="prefetch" href="/knowledge-system/assets/js/65.ba9ef164.js"><link rel="prefetch" href="/knowledge-system/assets/js/66.b8bd620a.js"><link rel="prefetch" href="/knowledge-system/assets/js/7.d0a41366.js"><link rel="prefetch" href="/knowledge-system/assets/js/8.f10d03d4.js"><link rel="prefetch" href="/knowledge-system/assets/js/9.c5fa4bb6.js">
    <link rel="stylesheet" href="/knowledge-system/assets/css/0.styles.c0d58452.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/knowledge-system/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/knowledge-system/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/knowledge-system/CSS/layout/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/knowledge-system/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/knowledge-system/broswer/work/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/knowledge-system/engineering/" class="nav-link router-link-active">
  工程化
</a></div><div class="nav-item"><a href="/knowledge-system/scene/lottieUsage/" class="nav-link">
  其他
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/knowledge-system/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/knowledge-system/CSS/layout/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/knowledge-system/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/knowledge-system/broswer/work/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/knowledge-system/engineering/" class="nav-link router-link-active">
  工程化
</a></div><div class="nav-item"><a href="/knowledge-system/scene/lottieUsage/" class="nav-link">
  其他
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>模块化、组件化和设计模式</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge-system/engineering/design/modularity.html" class="sidebar-link">模块化</a></li><li><a href="/knowledge-system/engineering/design/componential.html" class="sidebar-link">组件化</a></li><li><a href="/knowledge-system/engineering/design/design-pattern.html" class="sidebar-link">设计模式</a></li></ul></section></li><li><section class="sidebar-group depth-0"><a href="/knowledge-system/engineering/Vue/" class="sidebar-heading clickable"><span>Vue</span> <!----></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge-system/engineering/Vue/use.html" class="sidebar-link">使用</a></li><li><a href="/knowledge-system/engineering/Vue/principle.html" class="sidebar-link">原理</a></li><li><a href="/knowledge-system/engineering/Vue/Vue3.html" class="sidebar-link">Vue3</a></li></ul></section></li><li><a href="/knowledge-system/engineering/React/" class="sidebar-link">React</a></li><li><a href="/knowledge-system/engineering/vdom/" class="sidebar-link">vdom</a></li><li><section class="sidebar-group collapsable depth-0"><a href="/knowledge-system/engineering/webpack/" class="sidebar-heading clickable router-link-active open"><span>webpack</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge-system/engineering/webpack/main-flow.html" class="sidebar-link">主流程（主线剧情）</a></li><li><a href="/knowledge-system/engineering/webpack/chunk.html" class="sidebar-link">chunk</a></li><li><a href="/knowledge-system/engineering/webpack/SPA-MPA-MB.html" class="sidebar-link">SPA-MPA-MB</a></li><li><a href="/knowledge-system/engineering/webpack/optimization.html" class="sidebar-link">优化</a></li><li><a href="/knowledge-system/engineering/webpack/app-demo.html" aria-current="page" class="active sidebar-link">经验案例-iarrm插件化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#需求" class="sidebar-link">需求</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#插件化" class="sidebar-link">插件化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#基本思路" class="sidebar-link">基本思路</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#具体方案" class="sidebar-link">具体方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#与客户端通信" class="sidebar-link">与客户端通信</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#多主题功能" class="sidebar-link">多主题功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#基本思路-2" class="sidebar-link">基本思路</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#目录结构以及使用示例" class="sidebar-link">目录结构以及使用示例</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#how-to-分-chunk" class="sidebar-link">how to 分 chunk</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#" class="sidebar-link"></a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="标题没想好"><a href="#标题没想好" class="header-anchor">#</a> 标题没想好</h1> <h2 id="需求"><a href="#需求" class="header-anchor">#</a> 需求</h2> <ol><li><p>插件化。客户端有多个标签(可以理解为几个功能按钮的组合体)，标签类型有多种，从业务角度来讲，是对应多种不同的监控摄像头，从代码角度来讲，是对应多个 iarrm 插件。多个插件要完全独立，可以单独安装使用。点击一个标签中的一个按钮，根据当前标签的类型和点击的按钮，唤起对应的 web 页面, 相当于浏览器打开一个新的标签页。<br>
例如，安装了人脸插件的客户端，就携带有查看人脸抓拍历史、人脸实时抓拍情况、人脸数据统计图等功能。当点击人脸标签上的人脸历史按钮时，就打开人脸历史的 web 页面，使用其中的功能。
<img src="/knowledge-system/assets/img/app-demo-f1.92977ac8.png" alt="f1"></p></li> <li><p>支持多主题。客户端唤起网页时，通知 web 当前使用的主题，web 全局应用该主题。
<img src="/knowledge-system/assets/img/app-demo-f2.5cc3e4af.png" alt="f2"></p></li> <li><p>要提供一个脚手架（公司内部前端工程都是 webpack+vue）给分公司，当新增标签类型时，尽量能够复用组件，只开发业务。</p></li></ol> <p>根据需求可以分析出来几个技术点：1 插件化 2 多主题 3 客户端与 web 通信 4 脚手架。下面就逐一击破吧~</p> <h2 id="插件化"><a href="#插件化" class="header-anchor">#</a> 插件化</h2> <h3 id="基本思路"><a href="#基本思路" class="header-anchor">#</a> 基本思路</h3> <p>“插件化” 这个概念映射到前端工程代码，该怎么理解呢？</p> <p>① 根据需求多个插件完全独立，就说明每个插件~完整前端应用包</p> <blockquote><p>TIPS<br>
准确来讲每个插件对应前端应用包+后端应用包，但是我们这里不讨论后端。<br>
下文前端应用包或插件会使用 app 代指</p></blockquote> <p>这些插件对于前端开发来说，大多数的依赖和使用的组件都是相同的（比如上图的人脸、卡口插件都包含历史这个页面，页面上的具体功能都差不多。)
所以正确的方案应该是一个前端工程，可以输出多个不同的 app。这样更方便的实现组件的复用，也更方便项目的维护。</p> <p>② 根据需求，客户端标签中的每个按钮都会唤起一个 web 页面，所以每个 app 都包含多个 page，这是典型的 MPA。<br>
所以我们的每个 app 都是一个 MPA。</p> <h3 id="具体方案"><a href="#具体方案" class="header-anchor">#</a> 具体方案</h3> <p>假设我们的需要输出两个两个插件，demo 和 other，demo 包含两个页面 home 和 about，other 包含一个页面 home</p> <div class="language-code extra-class"><pre class="language-text"><code>
iarrm
  ├── demo
  |   ├──home
  |   └──about
  └── other
      └──home
</code></pre></div><p>我们期望生成的目录是这样滴，并且希望可以单独输出一个插件或多个插件一起输出</p> <div class="language- extra-class"><pre class="language-text"><code> plugins
      └── demo
      |   ├── demo-home.html
      |   ├── demo-about.html
      |   └── assets
      |       ├── js
      |       ├── css
      |       └── img
      └── other
          ├── other-home.html
          └── assets
              ├── js
              ├── css
              └── img

</code></pre></div><p>那么，在源码中，目录的基本骨架可以这样设置</p> <div class="language- extra-class"><pre class="language-text"><code>project
├── ...
└──src
  └── apps
      ├── demo                 // ~ app
      |   ├── home             // ~ page
      |   |   ├──main.js
      |   |   └──App.vue
      |   └── about            // ~ page
      |       ├──main.js
      |       └──App.vue
      └── other                // ~app
          └── home            // ~ page
              ├──main.js
              └──App.vue


</code></pre></div><p>通过命令行去控制具体输出某一个或多个 app<br>
配置命令行，关键点是 set PLUGIN_KEY=xxx</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">//package.json</span>
<span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build:demo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;set PLUGIN_KEY=demo&amp;&amp;vue-cli-service build&quot;</span><span class="token punctuation">,</span> <span class="token comment">//想要输出demo插件则执行这个命令</span>
    <span class="token property">&quot;build:other&quot;</span><span class="token operator">:</span> <span class="token string">&quot;set PLUGIN_KEY=other&amp;&amp;vue-cli-service build&quot;</span><span class="token punctuation">,</span><span class="token comment">//想要输出other插件则执行这个命令</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;npm run build:demo&amp;&amp;npm run build:other&quot;</span><span class="token punctuation">,</span><span class="token comment">//想要依次输出多个插件则用&amp;&amp;相连命令行</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>为每个插件配置输出位置</p> <div class="language-js extra-class"><pre class="language-js"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  outputDir<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">dist/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PLUGIN_KEY</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>配置 MPA，即为每个插件配置多页面。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> apps <span class="token operator">=</span> <span class="token punctuation">{</span>
  demo<span class="token operator">:</span> <span class="token punctuation">{</span>
    home<span class="token operator">:</span> <span class="token punctuation">{</span>
      entry<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/apps/demo/home/main.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// page 的入口(相对于项目的根目录)</span>
      template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/common/template/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// 模板来源(相对于项目的根目录)</span>
      filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">demo-home.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// 输出位置(相对于 outputDir</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    about<span class="token operator">:</span> <span class="token punctuation">{</span>
      entry<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/apps/demo/about/main.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/common/template/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">demo-about.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  other<span class="token operator">:</span> <span class="token punctuation">{</span>
    home<span class="token operator">:</span> <span class="token punctuation">{</span>
      entry<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/apps/other/home/main.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/common/template/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">other-home.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  pages<span class="token operator">:</span> apps<span class="token punctuation">[</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PLUGIN_KEY</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">//当 PLUGIN_KEY 为 demo 的时候，打包 demo 下的页面。</span>
  <span class="token comment">//    ......       other     .....  other</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>以输出 demo 插件为例，流程可以概括为<br> <img src="/knowledge-system/assets/img/app-demo-flow.35698f14.png" alt="app-demo-flow"></p> <p>打包出来的目录结构</p> <div class="language-code extra-class"><pre class="language-text"><code> dist
  └── demo
      ├── demo-home.html
      ├── demo-about.html
      └── assets
</code></pre></div><p>有图有真相<br> <img src="/knowledge-system/assets/img/app-demo-flow_demo.b5a94126.gif" alt="打包demo录屏"></p> <p>那如果 npm run build 是怎样的呢，看图就知道啦<br> <img src="/knowledge-system/assets/img/app-demo-flow_all.3aaf0ff7.gif" alt="打包录屏"></p> <p>直接打开 html 文件
<img src="/knowledge-system/assets/img/app-demo-flow_prod.ea3b347f.gif" alt="运行录屏"></p> <p>结果就是依次启动两次打包流程，相当于<br>
① 手动 npm run build:demo 输出文件后。<br>
② 然后再手动 npm run build:other 输出文件。</p> <p>以上已经能达到插件化的基本需求，对于生产环境来说没什么问题。但是对于开发环境下可能会不太方便，我们可能需要同时开发多个插件的多个页面。<br>
开发环境下我们就不分插件，让 apps 下面的所有 page 都参与打包。所以我们需要修改一下 pages 配置项，其他配置项不变。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> pages <span class="token operator">=</span> <span class="token punctuation">{</span>
  demoHome<span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/apps/demo/home/main.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// page 的入口(相对于项目的根目录)</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/common/template/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// 模板来源(相对于项目的根目录)</span>
    filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">demo-home.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token comment">// 输出位置(相对于 outputDir</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  demoAbout<span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/apps/demo/about/main.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/common/template/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">demo-about.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  otherHome<span class="token operator">:</span> <span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/apps/other/home/main.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    template<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/common/template/index.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">other-home.html</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  pages<span class="token operator">:</span> pages<span class="token punctuation">,</span>
  <span class="token comment">// apps下所有page</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>然后我们 npm run serve 启动项目<br>
可以正常运行
<img src="/knowledge-system/assets/img/app-demo-flow_dev.0f3faf74.gif" alt="dev环境"></p> <h2 id="与客户端通信"><a href="#与客户端通信" class="header-anchor">#</a> 与客户端通信</h2> <p>在这个项目中，通信这个功能，主要是客户端向 web 传达一些信息，web 是不需要主动调用客户端的功能的。所以只要弄明白 client 如何调用 js 就行了。<br>
其实 client-&gt;js 已经有了成熟的技术方案，前端需要做的就是在 window 上注册一个方法，client 调用这个方法进行一些信息的传达。<br>
每个页面功能不同，但都会传达的一个信息就是当前使用的主题，所以我们就以传递主题信息为例子。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// apps/demo/home/main.js</span>
window<span class="token punctuation">.</span><span class="token function-variable function">clientCallJs</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">{</span>skin<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">setSkin</span><span class="token punctuation">(</span>skin<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">setSkin</span><span class="token punctuation">(</span><span class="token parameter">skin</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 设置主题</span>
  <span class="token comment">// 下面小节将补充这个函数</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样，当客户端调用 clientCallJs 方法时，就会进入 js 内部的逻辑。我们根据 params 传参去做一些后续的事情。</p> <h2 id="多主题功能"><a href="#多主题功能" class="header-anchor">#</a> 多主题功能</h2> <h3 id="基本思路-2"><a href="#基本思路-2" class="header-anchor">#</a> 基本思路</h3> <p>结合这个项目的特点，多主题每次只会应用其中的一种，不需要在线换肤。所以采用的技术方案是，把多个主题分包，根据客户端传参去加载对应的文件，其他主题包不会用到，不需要去加载避免浪费资源。<br>
这里的关键点是分包，分包的方式有多种，<a href="https://juejin.cn/post/7004790532916379655" target="_blank" rel="noopener noreferrer">可以查看这篇文章：webpack chunk<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。结合这个项目的需求，采用 import() 函数这种分包方式，达到拆分和异步加载的目的。
假设 demo 插件有两种色系的主题，蓝色和绿色。以demo-home页面为例子，源码目录大概就是这样的：</p> <div class="language- extra-class"><pre class="language-text"><code>project
  └── ....
      ├── demo
      |   ├── home
      |   |   ├──main.js
      |   |   ├──themes
      |   |   |   ├──blue.less      //home页面蓝色主题样式定义在这里
      |   |   |   └──green.less     //home页面蓝色主题样式定义在这里
      |   |   └──App.vue
      |   └── ...
      └── ....
</code></pre></div><p>引入皮肤的代码雏形大概就是这样的</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// apps/demo/home/main.js</span>
<span class="token keyword">function</span> <span class="token function">setSkin</span><span class="token punctuation">(</span><span class="token parameter">skin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* webpackChunkName: &quot;themes-&quot; */</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./themes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>skin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.less</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>为了后面更加方便的介绍。我把 App.vue、blue.less、green.less 的代码贴一下</p> <div class="language-vue extra-class"><pre class="language-vue"><code>
</code></pre></div><h3 id="目录结构以及使用示例"><a href="#目录结构以及使用示例" class="header-anchor">#</a> 目录结构以及使用示例</h3> <div class="language-code extra-class"><pre class="language-text"><code>  src
  ├── main.js
  ├── ...
  ├── skin
  |   ├── green
  |   |   ├── theme.less # 定义一些主题通用的变量
  |   |   ├── demo-vars.less # 定义一些业务相关的变量
  |   |   └── index.less # green 主题的主人口 里面引用了green/theme.less、green/demo-vars.less、style/demo.less
  |   ├── blue
  |   |   ├── theme.less # 定义一些主题通用的变量
  |   |   ├── demo-vars.less # 定义一些业务相关的变量
  |   |   └── index.less # blue 主题的主人口 blue/theme.blue/demo-vars.less、style/demo.less
  |   └── style
  |       └── demo.less # demo 使用对应的业务变量或者直接引用主题变量定义样式
  └── ...

</code></pre></div><ul><li>green</li></ul> <div class="language-less extra-class"><pre class="language-less"><code><span class="token comment">// green/theme.less</span>
<span class="token variable">@main-color<span class="token punctuation">:</span></span> #08ff70<span class="token punctuation">;</span>
<span class="token variable">@main-act-color<span class="token punctuation">:</span></span> #e6941a<span class="token punctuation">;</span>
<span class="token variable">@text-color<span class="token punctuation">:</span></span> white<span class="token punctuation">;</span>
<span class="token comment">//green/demo-vars.less</span>
<span class="token variable">@demo-home-border-color<span class="token punctuation">:</span></span> lightgreen<span class="token punctuation">;</span>
<span class="token comment">// green/index.less 顺序必须是先引入变量文件然后引入业务代码</span>
<span class="token variable">@import</span> <span class="token string">&quot;./theme.less&quot;</span><span class="token punctuation">;</span>
<span class="token variable">@import</span> <span class="token string">&quot;./demo-vars.less&quot;</span><span class="token punctuation">;</span>
<span class="token variable">@import</span> <span class="token string">&quot;../style/demo.less&quot;</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>blue</li></ul> <div class="language-less extra-class"><pre class="language-less"><code><span class="token comment">//blue/theme.less</span>
<span class="token variable">@main-color<span class="token punctuation">:</span></span> #1a68c2<span class="token punctuation">;</span>
<span class="token variable">@main-act-color<span class="token punctuation">:</span></span> #e3e61a<span class="token punctuation">;</span>
<span class="token variable">@text-color<span class="token punctuation">:</span></span> white<span class="token punctuation">;</span>
<span class="token comment">//blue/demo-vars.less</span>
<span class="token variable">@demo-home-border-color<span class="token punctuation">:</span></span> skyblue<span class="token punctuation">;</span>
<span class="token comment">//blue/index.less 顺序必须是先引入变量文件然后引入业务代码</span>
<span class="token variable">@import</span> <span class="token string">&quot;./theme.less&quot;</span><span class="token punctuation">;</span>
<span class="token variable">@import</span> <span class="token string">&quot;./demo-vars.less&quot;</span><span class="token punctuation">;</span>
<span class="token variable">@import</span> <span class="token string">&quot;../style/demo.less&quot;</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>style</li></ul> <div class="language-less extra-class"><pre class="language-less"><code><span class="token comment">//style/demo.less</span>
<span class="token selector">.demo-home-root</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token variable">@main-color</span><span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 5px solid <span class="token variable">@demo-home-border-color</span><span class="token punctuation">;</span>
  <span class="token selector">&amp;:hover</span> <span class="token punctuation">{</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token variable">@main-act-color</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="how-to-分-chunk"><a href="#how-to-分-chunk" class="header-anchor">#</a> how to 分 chunk</h3> <p>引入 模块的几种方式 import、require、import()。这几种方式只有 import() 能实现自动划分 chunk，如果使用 import 或者 require 需要手动配置 splitChunk，所以采用了 import() 的方式。如果想要了解配置 splitChunk 主动划分移步 chunk 章节。</p> <blockquote><p>(webpack 官方提示：可以自己配置分包，但是不要在没有实践测量的情况下，尝试手动优化这些参数。默认模式是经过千挑万选的，可以用于满足最佳 web 性能的策略。)</p></blockquote> <h4 id="写法"><a href="#写法" class="header-anchor">#</a> 写法</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// apps/demo/home/main.js</span>
<span class="token keyword">function</span> <span class="token function">setSkin</span><span class="token punctuation">(</span><span class="token parameter">skin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* webpackChunkName: &quot;global-themes-&quot; */</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">./themes/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>skin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.less</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 使用魔法注释为chunk命名,这样打包出来的文件名就是global-themes0、global-themes1、...</span>
</code></pre></div><h4 id="打包后两个主题文件分别为-global-themes0-css-绿色主题对应的-css-、global-themes1-css-蓝色主题对应的-css"><a href="#打包后两个主题文件分别为-global-themes0-css-绿色主题对应的-css-、global-themes1-css-蓝色主题对应的-css" class="header-anchor">#</a> 打包后两个主题文件分别为 global-themes0.css(绿色主题对应的 css)、global-themes1.css (蓝色主题对应的 css)</h4> <div class="language-css extra-class"><pre class="language-css"><code><span class="token comment">/* global-themes0.css 绿色主题对应的css */</span>
<span class="token selector">.demo-home-root</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #08ff70<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 5px solid #90ee90<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.demo-home-root:hover</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #e6941a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* global-themes1.css 蓝色主题对应的css */</span>
<span class="token selector">.demo-home-root</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #1a68c2<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 5px solid #87ceeb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.demo-home-root:hover</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #e3e61a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id=""><a href="#" class="header-anchor">#</a></h2> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// vue.config.js -- 在生产环境下 ===== start</span>
<span class="token comment">// 当前的 process.env.PLUGIN_KEY值是 demo</span>
<span class="token comment">// 读取 src/pages/demo 下面的的所有目录，也就是 home、about</span>
<span class="token keyword">const</span> pageNameList <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>
  path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PLUGIN_KEY</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置当前plugin所有page下面的main.js为入口，也就是 home、about 目录下的 main.js 为两个入口</span>
pageNameList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pageName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  pages<span class="token punctuation">[</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pluginKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pluginKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/main.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最后形成的多页面配置项是这样的</span>
<span class="token comment">// pages:{</span>
<span class="token comment">//   &quot;demo-home&quot;:&quot;src/pages/demo/home/main.js&quot;,</span>
<span class="token comment">//   &quot;demo-about&quot;:&quot;src/pages/demo/about/main.js&quot;</span>
<span class="token comment">// }</span>
<span class="token comment">// vue.config.js -- 在生产环境下 ===== end</span>
<span class="token comment">// vue.config.js -- 在开发环境下 ===== start</span>
<span class="token keyword">const</span> pluginKeyList <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/pages</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pluginKeyList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pluginKey</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pageNameList <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>
    path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pluginKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
  pageNameList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pageName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    pages<span class="token punctuation">[</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pluginKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pluginKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/main.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">//根据pluginKey去配置pages选项</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// vue.config.js -- 在开发环境下 ===== end</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>pages <span class="token operator">=</span> pages<span class="token punctuation">;</span>
</code></pre></div><p>process.env.PLUGIN_KEY 拿到命令行中 PLUGIN_KEY=xxx 的 xxx。然后根据 process.env.PLUGIN_KEY 去 pages 对应的目录下找 main.js,配置 vue.config.js 中的 pages 选项。在开发环境下，是没有 process.env.PLUGIN_KEY 的，那么就是把 pages 下所有目录中的 main.js 都找到配置 vue.config.js 中的 pages 选项。</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/knowledge-system/engineering/webpack/optimization.html" class="prev">
        优化
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/knowledge-system/assets/js/app.efb8a36c.js" defer></script><script src="/knowledge-system/assets/js/2.380f0438.js" defer></script><script src="/knowledge-system/assets/js/4.17cbc09c.js" defer></script>
  </body>
</html>
