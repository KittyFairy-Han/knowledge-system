<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VuePress</title>
    <meta name="generator" content="VuePress 1.7.1">
    <link rel="icon" href="image/logo.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/knowledge-system/assets/css/0.styles.c0d58452.css" as="style"><link rel="preload" href="/knowledge-system/assets/js/app.1b6cc447.js" as="script"><link rel="preload" href="/knowledge-system/assets/js/2.bee64fa8.js" as="script"><link rel="preload" href="/knowledge-system/assets/js/59.3c87720b.js" as="script"><link rel="prefetch" href="/knowledge-system/assets/js/10.c769b7d0.js"><link rel="prefetch" href="/knowledge-system/assets/js/11.1e1e367e.js"><link rel="prefetch" href="/knowledge-system/assets/js/12.d2ba1673.js"><link rel="prefetch" href="/knowledge-system/assets/js/13.9a44f625.js"><link rel="prefetch" href="/knowledge-system/assets/js/14.e866dde1.js"><link rel="prefetch" href="/knowledge-system/assets/js/15.491b9dc3.js"><link rel="prefetch" href="/knowledge-system/assets/js/16.5bcc2612.js"><link rel="prefetch" href="/knowledge-system/assets/js/17.92c3c427.js"><link rel="prefetch" href="/knowledge-system/assets/js/18.afa54cf5.js"><link rel="prefetch" href="/knowledge-system/assets/js/19.4a7dbc09.js"><link rel="prefetch" href="/knowledge-system/assets/js/20.6cf0b865.js"><link rel="prefetch" href="/knowledge-system/assets/js/21.669105e9.js"><link rel="prefetch" href="/knowledge-system/assets/js/22.e2bab189.js"><link rel="prefetch" href="/knowledge-system/assets/js/23.35b88fd2.js"><link rel="prefetch" href="/knowledge-system/assets/js/24.537dd19c.js"><link rel="prefetch" href="/knowledge-system/assets/js/25.72ed9324.js"><link rel="prefetch" href="/knowledge-system/assets/js/26.a74281e5.js"><link rel="prefetch" href="/knowledge-system/assets/js/27.3b184dc9.js"><link rel="prefetch" href="/knowledge-system/assets/js/28.eda85087.js"><link rel="prefetch" href="/knowledge-system/assets/js/29.4644e48e.js"><link rel="prefetch" href="/knowledge-system/assets/js/3.e1deaa5f.js"><link rel="prefetch" href="/knowledge-system/assets/js/30.9b09b0c0.js"><link rel="prefetch" href="/knowledge-system/assets/js/31.341f0bf7.js"><link rel="prefetch" href="/knowledge-system/assets/js/32.95d1177a.js"><link rel="prefetch" href="/knowledge-system/assets/js/33.bcc042e8.js"><link rel="prefetch" href="/knowledge-system/assets/js/34.b2b4eb82.js"><link rel="prefetch" href="/knowledge-system/assets/js/35.602f8fa0.js"><link rel="prefetch" href="/knowledge-system/assets/js/36.2c789cb4.js"><link rel="prefetch" href="/knowledge-system/assets/js/37.26926d00.js"><link rel="prefetch" href="/knowledge-system/assets/js/38.0ab8dd3f.js"><link rel="prefetch" href="/knowledge-system/assets/js/39.e1a8ea2d.js"><link rel="prefetch" href="/knowledge-system/assets/js/4.3e4df967.js"><link rel="prefetch" href="/knowledge-system/assets/js/40.d5f7b151.js"><link rel="prefetch" href="/knowledge-system/assets/js/41.8fad559b.js"><link rel="prefetch" href="/knowledge-system/assets/js/42.7a70e4dc.js"><link rel="prefetch" href="/knowledge-system/assets/js/43.2f4b544d.js"><link rel="prefetch" href="/knowledge-system/assets/js/44.8f1c0613.js"><link rel="prefetch" href="/knowledge-system/assets/js/45.41edc0b3.js"><link rel="prefetch" href="/knowledge-system/assets/js/46.bfe2362c.js"><link rel="prefetch" href="/knowledge-system/assets/js/47.8cc49641.js"><link rel="prefetch" href="/knowledge-system/assets/js/48.a00e2b23.js"><link rel="prefetch" href="/knowledge-system/assets/js/49.29576c21.js"><link rel="prefetch" href="/knowledge-system/assets/js/5.55fb604f.js"><link rel="prefetch" href="/knowledge-system/assets/js/50.8315099a.js"><link rel="prefetch" href="/knowledge-system/assets/js/51.b10638c7.js"><link rel="prefetch" href="/knowledge-system/assets/js/52.f508a4fd.js"><link rel="prefetch" href="/knowledge-system/assets/js/53.988190b2.js"><link rel="prefetch" href="/knowledge-system/assets/js/54.5ff0d1d6.js"><link rel="prefetch" href="/knowledge-system/assets/js/55.466cab9e.js"><link rel="prefetch" href="/knowledge-system/assets/js/56.1edcc22e.js"><link rel="prefetch" href="/knowledge-system/assets/js/57.a4867ef8.js"><link rel="prefetch" href="/knowledge-system/assets/js/58.3d21a6ec.js"><link rel="prefetch" href="/knowledge-system/assets/js/6.8e56d089.js"><link rel="prefetch" href="/knowledge-system/assets/js/60.56173c49.js"><link rel="prefetch" href="/knowledge-system/assets/js/61.38047fd6.js"><link rel="prefetch" href="/knowledge-system/assets/js/62.532e022a.js"><link rel="prefetch" href="/knowledge-system/assets/js/63.9715cb77.js"><link rel="prefetch" href="/knowledge-system/assets/js/64.e6e8103e.js"><link rel="prefetch" href="/knowledge-system/assets/js/65.b45a1e4f.js"><link rel="prefetch" href="/knowledge-system/assets/js/66.3168e228.js"><link rel="prefetch" href="/knowledge-system/assets/js/7.ba66d306.js"><link rel="prefetch" href="/knowledge-system/assets/js/8.df279b40.js"><link rel="prefetch" href="/knowledge-system/assets/js/9.1f68d57b.js">
    <link rel="stylesheet" href="/knowledge-system/assets/css/0.styles.c0d58452.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/knowledge-system/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/knowledge-system/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/knowledge-system/CSS/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/knowledge-system/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/knowledge-system/broswer/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/knowledge-system/engineering/" class="nav-link router-link-active">
  工程化
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/knowledge-system/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/knowledge-system/CSS/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/knowledge-system/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/knowledge-system/broswer/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/knowledge-system/engineering/" class="nav-link router-link-active">
  工程化
</a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Vue</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge-system/engineering/Vue/use.html" class="sidebar-link">/engineering/Vue/use.html</a></li><li><a href="/knowledge-system/engineering/Vue/principle.html" class="sidebar-link">/engineering/Vue/principle.html</a></li><li><a href="/knowledge-system/engineering/Vue/Vue3.html" class="sidebar-link">/engineering/Vue/Vue3.html</a></li></ul></section></li><li><a href="/knowledge-system/engineering/vdom/" class="sidebar-link">vdom</a></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>webpack</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/knowledge-system/engineering/webpack/" aria-current="page" class="sidebar-link">webpack 工作流程</a></li><li><a href="/knowledge-system/engineering/webpack/chunk.html" class="sidebar-link">/engineering/webpack/chunk.html</a></li><li><a href="/knowledge-system/engineering/webpack/SPA-MPA-MB.html" class="sidebar-link">/engineering/webpack/SPA-MPA-MB.html</a></li><li><a href="/knowledge-system/engineering/webpack/optimization.html" class="sidebar-link">/engineering/webpack/optimization.html</a></li><li><a href="/knowledge-system/engineering/webpack/app-demo.html" aria-current="page" class="active sidebar-link">/engineering/webpack/app-demo.html</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#背景" class="sidebar-link">背景</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#需求" class="sidebar-link">需求</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#技术基础" class="sidebar-link">技术基础</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#插件化" class="sidebar-link">插件化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#总体方案" class="sidebar-link">总体方案</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#how-to-1-个工程-n-个包" class="sidebar-link">how to 1 个工程-&gt;N 个包</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#与客户端通信" class="sidebar-link">与客户端通信</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#换肤功能" class="sidebar-link">换肤功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#目录结构以及使用示例" class="sidebar-link">目录结构以及使用示例</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#how-to-分-chunk" class="sidebar-link">how to 分 chunk</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#webpack-通用优化" class="sidebar-link">webpack 通用优化</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#规范性方面" class="sidebar-link">规范性方面</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#css-文件" class="sidebar-link">css 文件</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/engineering/webpack/app-demo.html#js-文件" class="sidebar-link">js 文件</a></li></ul></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="iarrm-插件化"><a href="#iarrm-插件化" class="header-anchor">#</a> iarrm 插件化</h1> <h2 id="背景"><a href="#背景" class="header-anchor">#</a> 背景</h2> <h3 id="需求"><a href="#需求" class="header-anchor">#</a> 需求</h3> <ol><li>iarrm 整体是嵌在客户端里面的，客户端有标签(可以理解为几个按钮的组合体)，标签类型有多种，对应多个业务类型，对应多个 iarrm 插件。多个插件要完全独立，单独安装某个插件，该插件就包含了它自己所有的逻辑、资源、数据等等。</li> <li>点击一个标签中的一个按钮，则唤起 web 页面, 相当于浏览器打开一个新的标签页，根据当前标签的类型和点击的按钮，渲染对应的插件和插件中对应的页面。</li> <li>要提供一个脚手架给业务中心的人用，当新增标签类型时，尽量少配置，只开发业务就行。</li> <li>支持多皮肤，打开客户端之前选择一套皮肤，切换皮肤需要重启客户端。所以每次打开网页其实只会使用一套皮肤，不会出现动态切换。</li></ol> <h3 id="技术基础"><a href="#技术基础" class="header-anchor">#</a> 技术基础</h3> <p>webpack、vue</p> <h2 id="插件化"><a href="#插件化" class="header-anchor">#</a> 插件化</h2> <h3 id="总体方案"><a href="#总体方案" class="header-anchor">#</a> 总体方案</h3> <ol><li>根据需求多个插件完全独立，就说明多个插件对应多个 app，也就是多个前端包。但是这些插件对于前端开发来说，大多数的依赖和使用的组件都是相同的（比如人脸插件、人体插件都有用到轮播）。而且标签类型很多。所以每个标签用一个前端工程不好管理，开发效率太低，后期也不好维护。还是要用一个工程输出多个包。</li> <li>标签中的每个按钮点击都相当于在浏览器打开一个新的标签页。有两个方案，1 多页应用（每个按钮对应 webpack 中的多页的一个 page），2 单页应用结合路由懒加载（每个按钮对应 vue 的一个 router，结合路由懒加载。）。单页应用的优势就是在一个页面进行前端路由跳转，页面更新快，因为不用发 http 请求通过后端去返回一个新的页面了，转场动画页容易实现。但是对于这个需求来说，每次点击一个按钮都是重新打开一个标签页，无论如何都是发起一次 http 请求了，也不需要转场动画。所以单页应用的优势基本是没有应用到的。所以采用多页应用的形式。</li></ol> <blockquote><p>单页应用、多页应用、多个包、路由分割和懒加载详细对比见 SPA-MPA-MB 章节</p></blockquote> <h3 id="how-to-1-个工程-n-个包"><a href="#how-to-1-个工程-n-个包" class="header-anchor">#</a> how to 1 个工程-&gt;N 个包</h3> <h4 id="目录结构-关键部分-不包含任何业务相关的目录"><a href="#目录结构-关键部分-不包含任何业务相关的目录" class="header-anchor">#</a> 目录结构(关键部分，不包含任何业务相关的目录)</h4> <div class="language- extra-class"><pre class="language-text"><code>src
  └── pages
      └── demo # 对应一个 app
          ├── home #对应一个 page
          |   ├──main.js
          |   └──App.vue
          └── about #对应一个 page
              ├──main.js
              └──App.vue


</code></pre></div><div class="language- extra-class"><pre class="language-text"><code> plugins
      └── demo # app 根目录
          ├── demo-home.html # page：home
          ├── demo-about.html # page：about
          └── assets
              ├── js # 脚本资源目录
              ├── css # 样式资源目录
              └── img # 图片资源目录



</code></pre></div><h4 id="通过命令行控制"><a href="#通过命令行控制" class="header-anchor">#</a> 通过命令行控制</h4> <blockquote><p>STEP 1</p></blockquote> <p>set PLUGIN_KEY=xxx</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">//package.json</span>
<span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;build:demo&quot;</span><span class="token operator">:</span> <span class="token string">&quot;set PLUGIN_KEY=demo&amp;&amp;vue-cli-service build&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>STEP2</p></blockquote> <p>process.env.PLUGIN_KEY 拿到命令行中 PLUGIN_KEY=xxx 的 xxx。然后根据 process.env.PLUGIN_KEY 去 pages 对应的目录下找 main.js,配置 vue.config.js 中的 pages 选项。在开发环境下，是没有 process.env.PLUGIN_KEY 的，那么就是把 pages 下所有目录中的 main.js 都找到配置 vue.config.js 中的 pages 选项。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;path&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;fs&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> pages <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// vue.config.js -- 在生产环境下 ===== start</span>
<span class="token comment">// 当前的 process.env.PLUGIN_KEY值是 demo </span>
<span class="token comment">// 读取 src/pages/demo 下面的的所有目录，也就是 home、about</span>
<span class="token keyword">const</span> pageNameList <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">PLUGIN_KEY</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 设置当前plugin所有page下面的main.js为入口，也就是 home、about 目录下的 main.js 为两个入口</span>
pageNameList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pageName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  pages<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pluginKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pluginKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/main.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 最后形成的多页面配置项是这样的</span>
<span class="token comment">// pages:{</span>
<span class="token comment">//   &quot;demo-home&quot;:&quot;src/pages/demo/home/main.js&quot;,</span>
<span class="token comment">//   &quot;demo-about&quot;:&quot;src/pages/demo/about/main.js&quot;</span>
<span class="token comment">// }</span>
<span class="token comment">// vue.config.js -- 在生产环境下 ===== end</span>
<span class="token comment">// vue.config.js -- 在开发环境下 ===== start</span>
<span class="token keyword">const</span> pluginKeyList <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/pages</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
pluginKeyList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pluginKey</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> pageNameList <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pluginKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  pageNameList<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">pageName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    pages<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pluginKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">-</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">src/pages/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pluginKey<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pageName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/main.js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span> <span class="token comment">//根据pluginKey去配置pages选项</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// vue.config.js -- 在开发环境下 ===== end</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>pages <span class="token operator">=</span> pages<span class="token punctuation">;</span>
</code></pre></div><h2 id="与客户端通信"><a href="#与客户端通信" class="header-anchor">#</a> 与客户端通信</h2> <p>在 window 上注册一个方法供客户端调用，通过客户端传参设置皮肤等信息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// pages/demo/home/client-call.js</span>
window<span class="token punctuation">.</span><span class="token function-variable function">clientCallJs</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">params</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token punctuation">{</span>skin<span class="token punctuation">,</span>data<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>params<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>skin <span class="token operator">&amp;&amp;</span> data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;客户端传参不完整&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">setSkin</span><span class="token punctuation">(</span>skin<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">setSkin</span><span class="token punctuation">(</span><span class="token parameter">skin</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 设置皮肤</span>
  <span class="token comment">// 下面小节将补充这个函数</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="换肤功能"><a href="#换肤功能" class="header-anchor">#</a> 换肤功能</h2> <p>根据需求，多套皮肤每次需要根据客户端传参来决定使用其中的一套，也就是说可能有 5 套皮肤代码，但是其实浏览器中只需要用到 1/5。所以 5 套皮肤需要分 5 个文件，每次去加载其中 1 个文件，这样才合理。 如果全部都在一份文件中，那么一份文件体积过大，且实际用到的只是很小一部分，会造成浪费。在 webpack 中，最后的产生的文件都来源于 chunk，所以分文件就要知道怎么分 chunk。</p> <h3 id="目录结构以及使用示例"><a href="#目录结构以及使用示例" class="header-anchor">#</a> 目录结构以及使用示例</h3> <div class="language-code extra-class"><pre class="language-text"><code>  src
  └── skin
      ├── green
      |   ├── theme.less # 定义一些主题通用的变量
      |   ├── demo-vars.less # 定义一些业务相关的变量
      |   └── index.less # green 主题的主人口
      ├── blue
      |   ├── theme.less # 定义一些主题通用的变量
      |   ├── demo-vars.less # 定义一些业务相关的变量
      |   └── index.less # blue 主题的主人口
      └── style
          └── demo.less # demo 使用对应的业务变量或者直接引用主题变量定义样式

</code></pre></div><ul><li>green</li></ul> <div class="language-less extra-class"><pre class="language-less"><code><span class="token comment">// green/theme.less</span>
<span class="token variable">@main-color<span class="token punctuation">:</span></span> #08ff70<span class="token punctuation">;</span>
<span class="token variable">@main-act-color<span class="token punctuation">:</span></span> #e6941a<span class="token punctuation">;</span>
<span class="token variable">@text-color<span class="token punctuation">:</span></span> white<span class="token punctuation">;</span>
<span class="token comment">//green/demo-vars.less</span>
<span class="token variable">@demo-home-border-color<span class="token punctuation">:</span></span> lightgreen<span class="token punctuation">;</span>
<span class="token comment">// green/index.less 顺序必须是先引入变量文件然后引入业务代码</span>
<span class="token variable">@import</span> <span class="token string">&quot;./theme.less&quot;</span><span class="token punctuation">;</span>
<span class="token variable">@import</span> <span class="token string">&quot;./demo-vars.less&quot;</span><span class="token punctuation">;</span>
<span class="token variable">@import</span> <span class="token string">&quot;../style/demo.less&quot;</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>blue</li></ul> <div class="language-less extra-class"><pre class="language-less"><code><span class="token comment">//blue/theme.less</span>
<span class="token variable">@main-color<span class="token punctuation">:</span></span> #1a68c2<span class="token punctuation">;</span>
<span class="token variable">@main-act-color<span class="token punctuation">:</span></span> #e3e61a<span class="token punctuation">;</span>
<span class="token variable">@text-color<span class="token punctuation">:</span></span> white<span class="token punctuation">;</span>
<span class="token comment">//blue/demo-vars.less</span>
<span class="token variable">@demo-home-border-color<span class="token punctuation">:</span></span> skyblue<span class="token punctuation">;</span>
<span class="token comment">//blue/index.less 顺序必须是先引入变量文件然后引入业务代码</span>
<span class="token variable">@import</span> <span class="token string">&quot;./theme.less&quot;</span><span class="token punctuation">;</span>
<span class="token variable">@import</span> <span class="token string">&quot;./demo-vars.less&quot;</span><span class="token punctuation">;</span>
<span class="token variable">@import</span> <span class="token string">&quot;../style/demo.less&quot;</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>style</li></ul> <div class="language-less extra-class"><pre class="language-less"><code><span class="token comment">//style/demo.less</span>
<span class="token selector">.demo-home-root</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token variable">@main-color</span><span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 5px solid <span class="token variable">@demo-home-border-color</span><span class="token punctuation">;</span>
  <span class="token selector">&amp;:hover</span> <span class="token punctuation">{</span>
    <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token variable">@main-act-color</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="how-to-分-chunk"><a href="#how-to-分-chunk" class="header-anchor">#</a> how to 分 chunk</h3> <p>引入 模块的几种方式 import、require、import()。这几种方式只有 import() 能实现自动划分 chunk，如果使用 import 或者 require 需要手动配置 splitChunk，所以采用了 import() 的方式。如果想要了解配置 splitChunk 主动划分移步 chunk 章节。</p> <blockquote><p>(webpack 官方提示：可以自己配置分包，但是不要在没有实践测量的情况下，尝试手动优化这些参数。默认模式是经过千挑万选的，可以用于满足最佳 web 性能的策略。)</p></blockquote> <h4 id="写法"><a href="#写法" class="header-anchor">#</a> 写法</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// pages/demo/home/client-call.js</span>
<span class="token keyword">function</span> <span class="token function">setSkin</span><span class="token punctuation">(</span><span class="token parameter">skin</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* webpackChunkName: &quot;global-themes&quot; */</span>
  <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../../skin/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>skin<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.less</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 使用魔法注释为chunk命名,这样打包出来的文件名就是global-themes0、global-themes1、...</span>
</code></pre></div><h4 id="打包后两个皮肤文件分别为-global-themes0-css-绿色主题对应的-css-、global-themes1-css-蓝色主题对应的-css"><a href="#打包后两个皮肤文件分别为-global-themes0-css-绿色主题对应的-css-、global-themes1-css-蓝色主题对应的-css" class="header-anchor">#</a> 打包后两个皮肤文件分别为 global-themes0.css(绿色主题对应的 css)、global-themes1.css (蓝色主题对应的 css)</h4> <div class="language-css extra-class"><pre class="language-css"><code><span class="token comment">/* global-themes0.css 绿色主题对应的css */</span>
<span class="token selector">.demo-home-root</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #08ff70<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 5px solid #90ee90<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.demo-home-root:hover</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #e6941a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">/* global-themes1.css 蓝色主题对应的css */</span>
<span class="token selector">.demo-home-root</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #1a68c2<span class="token punctuation">;</span>
  <span class="token property">border</span><span class="token punctuation">:</span> 5px solid #87ceeb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token selector">.demo-home-root:hover</span> <span class="token punctuation">{</span>
  <span class="token property">background-color</span><span class="token punctuation">:</span> #e3e61a<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="webpack-通用优化"><a href="#webpack-通用优化" class="header-anchor">#</a> webpack 通用优化</h2> <p>移步webpack优化章节</p> <h2 id="规范性方面"><a href="#规范性方面" class="header-anchor">#</a> 规范性方面</h2> <blockquote><p>如何自定义打包后的文件名称？</p></blockquote> <h3 id="css-文件"><a href="#css-文件" class="header-anchor">#</a> css 文件</h3> <p>通过上文知道 css 文件就两种，一个是通过主入口 js 提取出来的 css，一个是异步 css。在 vue.config.js 中，前者命名配置 css.extract 选项，后者可以通过魔法注释。</p> <h4 id="如果是异步-import-产生的-chunk"><a href="#如果是异步-import-产生的-chunk" class="header-anchor">#</a> 如果是异步 import 产生的 chunk</h4> <p><a href="https://webpack.docschina.org/api/module-methods/#magic-comments" target="_blank" rel="noopener noreferrer">webpack 魔法注释<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// src/pages/demo/home/main.js</span>
<span class="token comment">// 就拿换肤那段代码举例子，可以这样写</span>
<span class="token keyword">import</span><span class="token punctuation">(</span>
  <span class="token comment">/* webpackChunkName: &quot;global-themes&quot; */</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../../skin/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>params<span class="token punctuation">.</span>tag<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/index.less</span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>输出 global-themes0.css、global-themes1.css</p> <h4 id="css-extract-的配置"><a href="#css-extract-的配置" class="header-anchor">#</a> css.extract 的配置</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// vue.config.js</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span>css<span class="token punctuation">.</span>extract <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// 入口js生成的chunk中提取出的css后，为css文件命名</span>
  <span class="token comment">// [name] 就是入口的key，src/pages/demo/home/main.js 配置pages选项的时候key是demo-home</span>
  filename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">assets/css/[name].css</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token comment">// 非入口文件生成chunk后，设置css文件名。</span>
  <span class="token comment">// 该项目中，非入口文件生成的css就是异步引入皮肤样式代码产生的，</span>
  <span class="token comment">// 在import()时使用了魔法注释，形成chunk时，名称就是遵照魔法注释来的，</span>
  <span class="token comment">// 我们希望最后生成的文件名与形成 chunk 时一致，所以仍然是 &quot;assets/css/[name].css&quot;</span>
  <span class="token comment">// 如果这一项不配置则会取 filename 的值，所以我们得配置为默认的 &quot;assets/css/[name].css&quot;</span>
  chunkFilename<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">assets/css/[name].css</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>输出 demo-home.css</p> <h3 id="js-文件"><a href="#js-文件" class="header-anchor">#</a> js 文件</h3> <p>通过上文，没有配置特定的插件，没有使用 splitChunk，输出的 js 来源也是只有两种，一个是主入口形成的，一个是懒加载的。懒加载的同 css 使用魔法注释。来源于主入口的可以通过配置 webpack 原生的 output 选项。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//vue.config.js</span>
module<span class="token punctuation">.</span>exports<span class="token punctuation">.</span><span class="token function-variable function">chainWebapck</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">config</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// [name] 就是入口的key，src/pages/demo/home/main.js 配置pages选项的时候key是demo-home</span>
  config<span class="token punctuation">.</span>output<span class="token punctuation">.</span><span class="token function">filename</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">assets/js/[name].js</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/knowledge-system/engineering/webpack/optimization.html" class="prev">
        /engineering/webpack/optimization.html
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/knowledge-system/assets/js/app.1b6cc447.js" defer></script><script src="/knowledge-system/assets/js/2.bee64fa8.js" defer></script><script src="/knowledge-system/assets/js/59.3c87720b.js" defer></script>
  </body>
</html>
