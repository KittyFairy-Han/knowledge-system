<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>h5 支付</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="image/logo.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/knowledge-system/assets/css/0.styles.bb9d180c.css" as="style"><link rel="preload" href="/knowledge-system/assets/js/app.3f30ee57.js" as="script"><link rel="preload" href="/knowledge-system/assets/js/2.1e2e5af0.js" as="script"><link rel="preload" href="/knowledge-system/assets/js/5.80a102c2.js" as="script"><link rel="prefetch" href="/knowledge-system/assets/js/10.83b8c0e1.js"><link rel="prefetch" href="/knowledge-system/assets/js/11.045bd3a3.js"><link rel="prefetch" href="/knowledge-system/assets/js/12.97bcf960.js"><link rel="prefetch" href="/knowledge-system/assets/js/13.bcb03fa2.js"><link rel="prefetch" href="/knowledge-system/assets/js/14.00ea3b8a.js"><link rel="prefetch" href="/knowledge-system/assets/js/15.39412c28.js"><link rel="prefetch" href="/knowledge-system/assets/js/16.8a5a354b.js"><link rel="prefetch" href="/knowledge-system/assets/js/17.d8dc25df.js"><link rel="prefetch" href="/knowledge-system/assets/js/18.70b99051.js"><link rel="prefetch" href="/knowledge-system/assets/js/19.f6d17ee0.js"><link rel="prefetch" href="/knowledge-system/assets/js/20.67c0def9.js"><link rel="prefetch" href="/knowledge-system/assets/js/21.cc3b5ad3.js"><link rel="prefetch" href="/knowledge-system/assets/js/22.de532c36.js"><link rel="prefetch" href="/knowledge-system/assets/js/23.3fc1899a.js"><link rel="prefetch" href="/knowledge-system/assets/js/24.0a93b35f.js"><link rel="prefetch" href="/knowledge-system/assets/js/25.4a50e71d.js"><link rel="prefetch" href="/knowledge-system/assets/js/26.96823b06.js"><link rel="prefetch" href="/knowledge-system/assets/js/27.25bdd59c.js"><link rel="prefetch" href="/knowledge-system/assets/js/28.c8be99d7.js"><link rel="prefetch" href="/knowledge-system/assets/js/29.d6fd4beb.js"><link rel="prefetch" href="/knowledge-system/assets/js/3.b58b8bc9.js"><link rel="prefetch" href="/knowledge-system/assets/js/30.27340547.js"><link rel="prefetch" href="/knowledge-system/assets/js/31.07a7065d.js"><link rel="prefetch" href="/knowledge-system/assets/js/32.97809239.js"><link rel="prefetch" href="/knowledge-system/assets/js/33.5e9b0afa.js"><link rel="prefetch" href="/knowledge-system/assets/js/34.baeb4fe7.js"><link rel="prefetch" href="/knowledge-system/assets/js/35.ba5aad26.js"><link rel="prefetch" href="/knowledge-system/assets/js/36.f674973f.js"><link rel="prefetch" href="/knowledge-system/assets/js/37.2ca6ce0e.js"><link rel="prefetch" href="/knowledge-system/assets/js/38.633749a3.js"><link rel="prefetch" href="/knowledge-system/assets/js/39.ac6cb7f8.js"><link rel="prefetch" href="/knowledge-system/assets/js/4.189e7355.js"><link rel="prefetch" href="/knowledge-system/assets/js/40.b462c041.js"><link rel="prefetch" href="/knowledge-system/assets/js/41.d19713dd.js"><link rel="prefetch" href="/knowledge-system/assets/js/42.cde09c06.js"><link rel="prefetch" href="/knowledge-system/assets/js/43.a8789389.js"><link rel="prefetch" href="/knowledge-system/assets/js/44.b195b929.js"><link rel="prefetch" href="/knowledge-system/assets/js/45.64bc5157.js"><link rel="prefetch" href="/knowledge-system/assets/js/46.2b25387f.js"><link rel="prefetch" href="/knowledge-system/assets/js/47.65b18197.js"><link rel="prefetch" href="/knowledge-system/assets/js/48.b124037e.js"><link rel="prefetch" href="/knowledge-system/assets/js/49.8cc09337.js"><link rel="prefetch" href="/knowledge-system/assets/js/50.a0ea1b99.js"><link rel="prefetch" href="/knowledge-system/assets/js/51.6e25ce67.js"><link rel="prefetch" href="/knowledge-system/assets/js/52.bd1249fa.js"><link rel="prefetch" href="/knowledge-system/assets/js/53.c95baf1a.js"><link rel="prefetch" href="/knowledge-system/assets/js/54.98cc87eb.js"><link rel="prefetch" href="/knowledge-system/assets/js/55.cf73dd3a.js"><link rel="prefetch" href="/knowledge-system/assets/js/56.7ba79579.js"><link rel="prefetch" href="/knowledge-system/assets/js/57.1ded6bd2.js"><link rel="prefetch" href="/knowledge-system/assets/js/58.f4e4bea0.js"><link rel="prefetch" href="/knowledge-system/assets/js/59.b1b2d7a8.js"><link rel="prefetch" href="/knowledge-system/assets/js/6.aceb1378.js"><link rel="prefetch" href="/knowledge-system/assets/js/60.de8ca4e2.js"><link rel="prefetch" href="/knowledge-system/assets/js/61.8a3ad4c5.js"><link rel="prefetch" href="/knowledge-system/assets/js/62.9bd79808.js"><link rel="prefetch" href="/knowledge-system/assets/js/63.bb6801ba.js"><link rel="prefetch" href="/knowledge-system/assets/js/64.a7df4753.js"><link rel="prefetch" href="/knowledge-system/assets/js/65.653d7658.js"><link rel="prefetch" href="/knowledge-system/assets/js/66.646278b2.js"><link rel="prefetch" href="/knowledge-system/assets/js/67.c66dbba0.js"><link rel="prefetch" href="/knowledge-system/assets/js/68.659ecec8.js"><link rel="prefetch" href="/knowledge-system/assets/js/69.4345b1e6.js"><link rel="prefetch" href="/knowledge-system/assets/js/7.940087ca.js"><link rel="prefetch" href="/knowledge-system/assets/js/70.8841fceb.js"><link rel="prefetch" href="/knowledge-system/assets/js/71.86c0d6e3.js"><link rel="prefetch" href="/knowledge-system/assets/js/72.09d929ca.js"><link rel="prefetch" href="/knowledge-system/assets/js/73.8dfd11d4.js"><link rel="prefetch" href="/knowledge-system/assets/js/74.0435c543.js"><link rel="prefetch" href="/knowledge-system/assets/js/75.365f1fe5.js"><link rel="prefetch" href="/knowledge-system/assets/js/76.179b6773.js"><link rel="prefetch" href="/knowledge-system/assets/js/77.7624563f.js"><link rel="prefetch" href="/knowledge-system/assets/js/78.cd90ba9a.js"><link rel="prefetch" href="/knowledge-system/assets/js/79.dc2b9603.js"><link rel="prefetch" href="/knowledge-system/assets/js/8.bb821eb8.js"><link rel="prefetch" href="/knowledge-system/assets/js/80.0627d816.js"><link rel="prefetch" href="/knowledge-system/assets/js/81.69905481.js"><link rel="prefetch" href="/knowledge-system/assets/js/82.230c2c48.js"><link rel="prefetch" href="/knowledge-system/assets/js/83.9d758fe5.js"><link rel="prefetch" href="/knowledge-system/assets/js/84.89b124f1.js"><link rel="prefetch" href="/knowledge-system/assets/js/85.3a9ca956.js"><link rel="prefetch" href="/knowledge-system/assets/js/86.e895f8b4.js"><link rel="prefetch" href="/knowledge-system/assets/js/87.4e7a893c.js"><link rel="prefetch" href="/knowledge-system/assets/js/88.a2c47419.js"><link rel="prefetch" href="/knowledge-system/assets/js/89.e0b9407c.js"><link rel="prefetch" href="/knowledge-system/assets/js/9.1b6ddf34.js"><link rel="prefetch" href="/knowledge-system/assets/js/90.fefc2a4b.js">
    <link rel="stylesheet" href="/knowledge-system/assets/css/0.styles.bb9d180c.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/knowledge-system/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/knowledge-system/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/knowledge-system/CSS/layout/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/knowledge-system/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/knowledge-system/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/knowledge-system/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/knowledge-system/broswer/work/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/knowledge-system/engineering/" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/knowledge-system/scene/lottieUsage/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/knowledge-system/web3d/" class="nav-link">
  web3d
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/knowledge-system/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/knowledge-system/CSS/layout/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/knowledge-system/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/knowledge-system/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/knowledge-system/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/knowledge-system/broswer/work/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/knowledge-system/engineering/" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/knowledge-system/scene/lottieUsage/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/knowledge-system/web3d/" class="nav-link">
  web3d
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/knowledge-system/scene/lottieUsage.html" class="sidebar-link">lottie的应用场景</a></li><li><a href="/knowledge-system/scene/screenshoots.html" class="sidebar-link">前端截屏方案</a></li><li><a href="/knowledge-system/scene/modelViewer.html" class="sidebar-link">modelViewer</a></li><li><a href="/knowledge-system/scene/cli.html" class="sidebar-link">脚手架工具</a></li><li><a href="/knowledge-system/scene/vscode-extension.html" class="sidebar-link">vscode插件</a></li><li><a href="/knowledge-system/scene/pay.html" aria-current="page" class="active sidebar-link">支付</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/scene/pay.html#从前端的角度看-下单、支付-流程" class="sidebar-link">从前端的角度看 下单、支付 流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/scene/pay.html#tips" class="sidebar-link">tips</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/pay.html#浏览器环境-支付宝支付" class="sidebar-link">浏览器环境-支付宝支付</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/scene/pay.html#模拟表单提交-支付" class="sidebar-link">模拟表单提交（支付）</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/pay.html#检查支付状态" class="sidebar-link">检查支付状态</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/pay.html#tips-2" class="sidebar-link">tips</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/pay.html#浏览器环境-微信支付" class="sidebar-link">浏览器环境-微信支付</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/scene/pay.html#tips-3" class="sidebar-link">tips</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/pay.html#微信环境-微信支付" class="sidebar-link">微信环境-微信支付</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/scene/pay.html#授权" class="sidebar-link">授权</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/pay.html#支付" class="sidebar-link">支付</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/pay.html#授权发生的时机" class="sidebar-link">授权发生的时机</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="h5-支付"><a href="#h5-支付" class="header-anchor">#</a> h5 支付</h1> <p><img src="/knowledge-system/assets/img/pay1.3662d4a1.png" alt="场景+渠道"><br>
分为如图的六种情况，<br>
其中，微信环境用支付宝支付是行不通的，<a href="https://opendocs.alipay.com/support/01rfu4" target="_blank" rel="noopener noreferrer">这里是支付宝官方说明<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>；</p> <h2 id="从前端的角度看-下单、支付-流程"><a href="#从前端的角度看-下单、支付-流程" class="header-anchor">#</a> 从前端的角度看 下单、支付 流程</h2> <p><img src="/knowledge-system/assets/img/pay2.21aaf068.png" alt="总流程"><br>
总体来说分为</p> <ol><li>下单：接口调用成功则进行了库存扣减</li> <li>准备支付：此时调用业务后端的支付接口，获取需要传给第三方信息或者跳转到第三方的 url</li> <li>进行支付：调用第三方 sdk 或者跳转到第三方支付页面</li> <li>返回：支付成功后进行后续流程，跳转进行的支付需要手动检查支付状态</li></ol> <h3 id="tips"><a href="#tips" class="header-anchor">#</a> tips</h3> <p>到<span style="color:#a8cb98;">第 2 步</span>失败：<br>
业务后端并没有记录到支付渠道，所以继续支付时需要<b style="color:#d79593;">重新选择支付方式</b>然后直接进行<b style="color:#a8cb98;">准备支付流程</b></p> <p><img src="/knowledge-system/assets/img/pay3.b19e2dd3.png" alt="失败情况1"></p> <p>到<span style="color:#8ea9ce;">第 3 步</span>失败：<br> <b style="color:#d79593;">继续支付</b>时进入<b style="color:#a8cb98;">准备支付流程</b>，获取支付需要的信息，然后继续后面的流程</p> <p><img src="/knowledge-system/assets/img/pay4.65da8b5b.png" alt="失败情况2"></p> <p>不过，不同的支付渠道，不同的环境还需要不同的处理，下面分情况聊聊，代码都是 React 代码片段</p> <h2 id="浏览器环境-支付宝支付"><a href="#浏览器环境-支付宝支付" class="header-anchor">#</a> 浏览器环境-支付宝支付</h2> <p>要成功的调用支付宝支付，需要到支付宝开放平台进行一系列的配置，<a href="https://opendocs.alipay.com/open/203/107084" target="_blank" rel="noopener noreferrer">查看官方文档：接入前准备<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，虽然这些可能是其他人去配的，但开发必须懂，要不然遇到问题不知道哪里配的不对，真的很麻烦。<br>
总流程的步骤 2 到步骤 4 之间的详细流程如图<br> <img src="/knowledge-system/assets/img/pay-h5-ali-1.4a6f1d19.png" alt="浏览器-支付宝流程"></p> <h3 id="模拟表单提交-支付"><a href="#模拟表单提交-支付" class="header-anchor">#</a> 模拟表单提交（支付）</h3> <p>后端调用支付宝接口后拿到表单字符串，然后返回给前端，前端模拟表单提交又调用到了支付宝的后端接口，然后跳转到支付宝的 h5 页面</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">h5AliPay</span> <span class="token operator">=</span> <span class="token punctuation">(</span>payHtml<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">&quot;div&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> payHtml<span class="token punctuation">;</span>
  div<span class="token punctuation">.</span>id <span class="token operator">=</span> <span class="token string">&quot;form-wrapper-for-alipay&quot;</span><span class="token punctuation">;</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>div<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> form <span class="token operator">=</span> div<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">&quot;form&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  form<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>2023 年 6 月支付宝对外的支付方案升级了，原来是业务端通过参数拼接访问 url，现在是模拟表单提交</p></blockquote> <h3 id="检查支付状态"><a href="#检查支付状态" class="header-anchor">#</a> 检查支付状态</h3> <p>和前端关系密切的另一个流程就是回到我们的 h5 页面需要检查支付状态，分如图的三种情况。其中：</p> <ul><li><strong>情况 2</strong>和<strong>情况 3</strong>是支付宝跳转的，跳转地址是后端接口通过 return_url 传给支付宝的，一般 return_url 和发起支付的页面是同样的路由，这两种情况是<strong>路由继续堆栈</strong>的；</li> <li><strong>情况 1</strong>是<strong>路由出栈返回</strong>发起支付的页面<br>
假设在详情页（<code>/detail?id=xxx</code>）支付，<code>return_url</code> 也是详情页。那我们需要考虑的细节有两个</li></ul> <h4 id="_1-详情页有两种状态-购买操作前、购买操作后"><a href="#_1-详情页有两种状态-购买操作前、购买操作后" class="header-anchor">#</a> 1.详情页有两种状态：购买操作前、购买操作后</h4> <p>详情页需要区分是购买前还是购买后，购买后进入页面就要弹窗检查，购买前不需要<br>
在笔者看来这里只有两个方案，① 路由参数定义一个标识 ② 本地存储，毕竟已经跳出我们的应用了，store 啥的肯定不行，当时笔者采用的是方案 ①<br> <code>return_url</code> 定义为 <code>/detail?id=xxx&amp;orderNo=xxx</code>，有<code>orderNo</code>则弹窗</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token string">&quot;orderNo&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> checkCountRef<span class="token punctuation">.</span>current <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 因为 useEffect(()=&gt;,[]) 会触发两次，所以这里checkCountRef.current计数一下</span>
    <span class="token function">H5PayStatusHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//弹窗逻辑</span>
    checkCountRef<span class="token punctuation">.</span>current<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>不过还有个问题，要兼容情况 1，所以在跳转到第三方支付平台之前要主动进行路由替换，因为路由没变只是参数变化，所以页面不会跳转刷新和重新渲染等，能够做到用户无感知</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">beforeJumpTo</span> <span class="token operator">=</span> <span class="token punctuation">(</span>orderNo<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pathname<span class="token punctuation">,</span> search <span class="token punctuation">}</span> <span class="token operator">=</span> location<span class="token punctuation">;</span>
  <span class="token keyword">const</span> newRoute <span class="token operator">=</span> search <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>search<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;orderNo=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>orderNo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?orderNo=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>orderNo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token function">navigate</span><span class="token punctuation">(</span>newRoute<span class="token punctuation">,</span> <span class="token punctuation">{</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">h5AliPay</span> <span class="token operator">=</span> <span class="token punctuation">(</span>payHtml<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">const</span> form <span class="token operator">=</span> div<span class="token punctuation">.</span><span class="token function">getElementsByTagName</span><span class="token punctuation">(</span><span class="token string">&quot;form&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token function">beforeJumpTo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  form<span class="token punctuation">.</span><span class="token function">submit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>✨ 这里不直接指定路由而是动态计算路+径参数，是因为考虑多个页面通用，我们的项目中支付行为发生在三个页面，这些逻辑都是写在 hook 中共用的</p></blockquote> <p>检查支付状态后要把<code>orderNo</code>去掉，否则路径 2 到详情页，会再次弹窗。</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">afterJumpBackAndCheck</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pathname <span class="token punctuation">}</span> <span class="token operator">=</span> location<span class="token punctuation">;</span>
  searchParams<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;orderNo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> search <span class="token operator">=</span> searchParams<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> newRoute <span class="token operator">=</span> search <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>search<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token function">navigate</span><span class="token punctuation">(</span>newRoute<span class="token punctuation">,</span> <span class="token punctuation">{</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">H5PayStatusHandler</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// Modal ...</span>
  <span class="token function">afterJumpBackAndCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>❓ 其实还有个问题，情况 3 会拼接很多支付宝支付相关的参数，此时这个页面无法再次成功的发起支付，这些参数也要剔除。这个在下面小结一起解决</p></blockquote> <h4 id="_2-详情页又返回详情页了"><a href="#_2-详情页又返回详情页了" class="header-anchor">#</a> 2.详情页又返回详情页了？</h4> <p>假设现在是由情况 3 到详情页，检查支付状态后，路径 1，就是从详情页返回到详情页，并且会再次弹窗。为了避免这个情况，笔者的思路是如果是情况 3 或者情况 2，自动进行路由出栈。也就是这样<br> <img src="/knowledge-system/assets/img/pay-h5-ali-2.6e36a3d5.png" alt="解决后"><br>
这样就也同时解决了上一小结遗留的问题！那就再加个参数<code>fromThirdPayPlatform</code>区分咯</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;=======  useEffect [] ======&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>searchParams<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token string">&quot;fromThirdPayPlatform&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;======= fromThirdPayPlatform 从第三方平台回来 ======&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">navigate</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token string">&quot;orderNo&quot;</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> checkCountRef<span class="token punctuation">.</span>current <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;======= orderNo 发起支付的页面 ======&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">H5PayStatusHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    checkCountRef<span class="token punctuation">.</span>current<span class="token operator">++</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="_3-兼容华为原生浏览器"><a href="#_3-兼容华为原生浏览器" class="header-anchor">#</a> 3.兼容华为原生浏览器</h4> <p>问题是：<br>
路由出栈时，不会触发页面 render，也就是说回到发起支付的页面不会走到 <code>useEffect(()=&gt;,[])</code> 这段逻辑, 就没办法弹窗了。笔者采用的方法是用这个 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Document/visibilitychange_event" target="_blank" rel="noopener noreferrer">visibilitychange<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 事件</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHuawei</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;visibilitychange&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>visibilityState <span class="token operator">===</span> <span class="token string">&quot;visible&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token string">&quot;orderNo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">H5PayStatusHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="tips-2"><a href="#tips-2" class="header-anchor">#</a> tips</h3> <p>支付宝中，h5页面使用支付宝支付和浏览器中使用支付宝支付完全可以看做一个流程，只是少了app切换那一步。</p> <h2 id="浏览器环境-微信支付"><a href="#浏览器环境-微信支付" class="header-anchor">#</a> 浏览器环境-微信支付</h2> <p>要成功调用微信支付，要到微信支付平台做一些<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_6_1.shtml" target="_blank" rel="noopener noreferrer">接入前的准备<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a><a href="https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_6_2.shtml" target="_blank" rel="noopener noreferrer">开发指引<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>。微信比支付宝要麻烦一些，需要到<a href="https://pay.weixin.qq.com/" target="_blank" rel="noopener noreferrer">商户平台<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>（mchid）和<a href="https://mp.weixin.qq.com/" target="_blank" rel="noopener noreferrer">公众号<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>平台（appid）同时操作，并进行 appid 和 mchid 的关联以及一系列的其他配置，具体看官方文档吧。<br>
总流程的步骤 2 到步骤 4 之间的详细流程如图<br> <img src="/knowledge-system/assets/img/pay-h5-wx-1.b8193054.png" alt="浏览器-微信支付流程">
其实和浏览器环境的支付宝支付差不多，面临的问题和处理方式也和支付宝支付一样，这里就只说一下区别点：</p> <ul><li>支付宝返回的是表单字符串，微信返回的是 url。</li> <li>redirect_url 携带在路由参数中，需要业务端去拼接（笔者做项目时，是让后端拼接的哈哈哈哈）
<blockquote><p>redirect_url 非必须，默认返回发起支付的页面，❓ 是跳转还是返回</p></blockquote></li></ul> <h3 id="tips-3"><a href="#tips-3" class="header-anchor">#</a> tips</h3> <p>支付宝中使用微信支付这种场景我们项目中没太考虑，待补充。预估两种情况①不能支付②和浏览器中使用微信支付一样。</p> <h2 id="微信环境-微信支付"><a href="#微信环境-微信支付" class="header-anchor">#</a> 微信环境-微信支付</h2> <p>虽然都是微信支付，但在微信环境调用微信支付和其他浏览器内调用微信支付流程上完全不同。<br>
对于前端开发来说，利好是不用每次跳到站外去支付，也就不用检查支付状态，不用处理各种路由情况了。但是！重要的永远是后半句 O(∩_∩)O 哈哈~支付前多了一个流程：<strong>授权</strong>。</p> <h3 id="授权"><a href="#授权" class="header-anchor">#</a> 授权</h3> <p>授权相关配置参考<a href="https://pay.weixin.qq.com/wiki/doc/apiv3/open/pay/chapter2_3.shtml" target="_blank" rel="noopener noreferrer">官方文档这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>，先展示一下授权流程：</p> <p><img src="/knowledge-system/assets/img/pay-wx-auth.025ed1f1.png" alt="wx-sdk-auth"><br>
一般情况下是否授权都是从用户信息接口获取，授权是通过跳转行为完成，</p> <ol><li>跳转时通过路由参数携带的两个重要信息是 appid 和 return_uri, 跳转回来微信会通过路由参数传递给业务层 code，</li> <li>业务后端通过 code 置换 openid，并存在用户信息接口</li></ol> <p>下次识别到用户信息中标记为已授权，就不用再走一次流程了</p> <blockquote><p>虽然从代码上来是跳转行为，实际上表现并不会离开当前页面，而是弹窗的形式，可以理解为和微信的一种通信方式</p></blockquote> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token function-variable function">toAuth</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> encodeUrl <span class="token operator">=</span> <span class="token function">encodeURIComponent</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">)</span><span class="token punctuation">;</span>
  window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">https://open.weixin.qq.com/connect/oauth2/authorize?appid=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">APPID</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;redirect_uri=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>encodeUrl<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;response_type=code&amp;scope=snsapi_base&amp;state=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">WX_AUTH_STATE</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">#wechat_redirect</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> <span class="token function-variable function">afterWxAuth</span> <span class="token operator">=</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>code<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">await</span> <span class="token function">setOpenId</span><span class="token punctuation">(</span><span class="token punctuation">{</span> code <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//code 置换 openid</span>
  <span class="token function">getUserInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//更新用户信息</span>
  <span class="token comment">// 处理路由：为了用户授权后，路由到别的页面，再返回时，不再重复afterWxAuth流程</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> pathname <span class="token punctuation">}</span> <span class="token operator">=</span> location<span class="token punctuation">;</span>
  searchParams<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  searchParams<span class="token punctuation">.</span><span class="token function">delete</span><span class="token punctuation">(</span><span class="token string">&quot;state&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> search <span class="token operator">=</span> searchParams<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> newRoute <span class="token operator">=</span> search <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>search<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span> <span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pathname<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token function">navigate</span><span class="token punctuation">(</span>newRoute<span class="token punctuation">,</span> <span class="token punctuation">{</span> replace<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token function">useEffect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> code <span class="token operator">=</span> <span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token string">&quot;code&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> state <span class="token operator">=</span> <span class="token function">getQuery</span><span class="token punctuation">(</span><span class="token string">&quot;state&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">&amp;&amp;</span> state <span class="token operator">===</span> <span class="token constant">WX_AUTH_STATE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">afterWxAuth</span><span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//说明是微信授权通过了</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="支付"><a href="#支付" class="header-anchor">#</a> 支付</h3> <p>还记得文章最开始的支付总流程图吗？<br>
授权过程插到总流程图中大概是这样的：<br> <img src="/knowledge-system/assets/img/pay-wx-sdk-1.9462073a.png" alt="sdk支付">
可以看到，支付总流程的<span style="color:#8ea9ce;">第 3 步</span>和<span style="color:#c2accc;">第 4 步</span>都简化了，代码上的变化：</p> <ul><li>引入 sdk，WeixinJSBridge 对象才挂在全局</li></ul> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://res.wx.qq.com/open/js/jweixin-1.4.0.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><ul><li>调用微信 sdk</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> appId<span class="token punctuation">,</span> channel<span class="token punctuation">,</span> nonce<span class="token punctuation">,</span> packageNo<span class="token punctuation">,</span> prepayId<span class="token punctuation">,</span> redirectUrl<span class="token punctuation">,</span> sign<span class="token punctuation">,</span> timestamp<span class="token punctuation">,</span> url <span class="token punctuation">}</span> <span class="token operator">=</span> payData<span class="token punctuation">;</span>
    <span class="token comment">//大多数字段都是要后端通过步骤2给前端</span>
    <span class="token keyword">const</span> payload <span class="token operator">=</span> <span class="token punctuation">{</span>
      appId<span class="token punctuation">,</span><span class="token comment">//这个是个固定值，可以不从后端接口取</span>
      timeStamp<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>timestamp<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      nonceStr<span class="token operator">:</span> nonce<span class="token punctuation">,</span>
      <span class="token keyword">package</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">prepay_id=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prepayId<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
      signType<span class="token operator">:</span> <span class="token string">&quot;RSA&quot;</span><span class="token punctuation">,</span>
      paySign<span class="token operator">:</span> sign<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    WeixinJSBridge<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">&quot;getBrandWCPayRequest&quot;</span><span class="token punctuation">,</span> payload<span class="token punctuation">,</span><span class="token punctuation">(</span>res<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>err_msg <span class="token operator">===</span> <span class="token string">&quot;get_brand_wcpay_request:ok&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//支付成功逻辑</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>err_msg <span class="token operator">===</span> <span class="token string">&quot;get_brand_wcpay_request:cancel&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//取消支付</span>
        <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">.</span>err_msg <span class="token operator">===</span> <span class="token string">&quot;get_brand_wcpay_request:fail&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//支付失败</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre></div><h3 id="授权发生的时机"><a href="#授权发生的时机" class="header-anchor">#</a> 授权发生的时机</h3> <p>从理论上讲，需要微信授权要同时满足两个条件①在微信环境②选择微信支付。所以在支付的总流程图中，授权出现在已经确定了支付方式和下单之后：<br> <img src="/knowledge-system/assets/img/pay-wx-sdk-2.3de1d833.png" alt="sdk-auth-when"><br>
不过，我们产品的逻辑稍微调整了一下，把授权前置了<br> <img src="/knowledge-system/assets/img/pay-wx-sdk-3.2d3b7822.png" alt="sdk-auth-when"><br>
取决于产品逻辑，可供参考</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/knowledge-system/scene/vscode-extension.html" class="prev">
        vscode插件
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/knowledge-system/assets/js/app.3f30ee57.js" defer></script><script src="/knowledge-system/assets/js/2.1e2e5af0.js" defer></script><script src="/knowledge-system/assets/js/5.80a102c2.js" defer></script>
  </body>
</html>
