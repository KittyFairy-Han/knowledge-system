<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>需求</title>
    <meta name="generator" content="VuePress 1.9.10">
    <link rel="icon" href="image/logo.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/knowledge-system/assets/css/0.styles.1f67f494.css" as="style"><link rel="preload" href="/knowledge-system/assets/js/app.744a76bb.js" as="script"><link rel="preload" href="/knowledge-system/assets/js/2.2562ca4f.js" as="script"><link rel="preload" href="/knowledge-system/assets/js/1.8b017304.js" as="script"><link rel="preload" href="/knowledge-system/assets/js/16.ddb321b8.js" as="script"><link rel="prefetch" href="/knowledge-system/assets/js/10.e2e766c3.js"><link rel="prefetch" href="/knowledge-system/assets/js/100.61058c7c.js"><link rel="prefetch" href="/knowledge-system/assets/js/101.858c32c1.js"><link rel="prefetch" href="/knowledge-system/assets/js/102.e1d88b5b.js"><link rel="prefetch" href="/knowledge-system/assets/js/103.d4a262c7.js"><link rel="prefetch" href="/knowledge-system/assets/js/104.200daf6b.js"><link rel="prefetch" href="/knowledge-system/assets/js/105.7e6b68b3.js"><link rel="prefetch" href="/knowledge-system/assets/js/106.48d11ad6.js"><link rel="prefetch" href="/knowledge-system/assets/js/107.b5b5f15c.js"><link rel="prefetch" href="/knowledge-system/assets/js/108.e7ffd05c.js"><link rel="prefetch" href="/knowledge-system/assets/js/109.f1ac8437.js"><link rel="prefetch" href="/knowledge-system/assets/js/11.0c934087.js"><link rel="prefetch" href="/knowledge-system/assets/js/110.65f5c30f.js"><link rel="prefetch" href="/knowledge-system/assets/js/111.19148b5b.js"><link rel="prefetch" href="/knowledge-system/assets/js/112.61c055bc.js"><link rel="prefetch" href="/knowledge-system/assets/js/113.faaf3f5d.js"><link rel="prefetch" href="/knowledge-system/assets/js/114.c44ec05f.js"><link rel="prefetch" href="/knowledge-system/assets/js/115.5c9997c9.js"><link rel="prefetch" href="/knowledge-system/assets/js/116.f6903df3.js"><link rel="prefetch" href="/knowledge-system/assets/js/117.360bd58a.js"><link rel="prefetch" href="/knowledge-system/assets/js/12.95c9a347.js"><link rel="prefetch" href="/knowledge-system/assets/js/13.3a840b0a.js"><link rel="prefetch" href="/knowledge-system/assets/js/14.ba2ba6cb.js"><link rel="prefetch" href="/knowledge-system/assets/js/15.3d96b3d1.js"><link rel="prefetch" href="/knowledge-system/assets/js/17.108a8d20.js"><link rel="prefetch" href="/knowledge-system/assets/js/18.91cc2463.js"><link rel="prefetch" href="/knowledge-system/assets/js/19.713fcc0f.js"><link rel="prefetch" href="/knowledge-system/assets/js/20.153f19b1.js"><link rel="prefetch" href="/knowledge-system/assets/js/21.60aaec96.js"><link rel="prefetch" href="/knowledge-system/assets/js/22.759607fe.js"><link rel="prefetch" href="/knowledge-system/assets/js/23.d6eab9bd.js"><link rel="prefetch" href="/knowledge-system/assets/js/24.abcdffb3.js"><link rel="prefetch" href="/knowledge-system/assets/js/25.ea680c99.js"><link rel="prefetch" href="/knowledge-system/assets/js/26.9bba005a.js"><link rel="prefetch" href="/knowledge-system/assets/js/27.46747b77.js"><link rel="prefetch" href="/knowledge-system/assets/js/28.592ddb80.js"><link rel="prefetch" href="/knowledge-system/assets/js/29.67808962.js"><link rel="prefetch" href="/knowledge-system/assets/js/3.76be74e7.js"><link rel="prefetch" href="/knowledge-system/assets/js/30.3c236e05.js"><link rel="prefetch" href="/knowledge-system/assets/js/31.91774148.js"><link rel="prefetch" href="/knowledge-system/assets/js/32.5655abbf.js"><link rel="prefetch" href="/knowledge-system/assets/js/33.aa620044.js"><link rel="prefetch" href="/knowledge-system/assets/js/34.b7a75e8c.js"><link rel="prefetch" href="/knowledge-system/assets/js/35.8a81bea6.js"><link rel="prefetch" href="/knowledge-system/assets/js/36.7c498752.js"><link rel="prefetch" href="/knowledge-system/assets/js/37.f85d624c.js"><link rel="prefetch" href="/knowledge-system/assets/js/38.f4a6133d.js"><link rel="prefetch" href="/knowledge-system/assets/js/39.34cf94b8.js"><link rel="prefetch" href="/knowledge-system/assets/js/4.652c7830.js"><link rel="prefetch" href="/knowledge-system/assets/js/40.d4e090d0.js"><link rel="prefetch" href="/knowledge-system/assets/js/41.e7a01d97.js"><link rel="prefetch" href="/knowledge-system/assets/js/42.c25c23de.js"><link rel="prefetch" href="/knowledge-system/assets/js/43.3016360f.js"><link rel="prefetch" href="/knowledge-system/assets/js/44.37c512be.js"><link rel="prefetch" href="/knowledge-system/assets/js/45.b5df5082.js"><link rel="prefetch" href="/knowledge-system/assets/js/46.bc0039b8.js"><link rel="prefetch" href="/knowledge-system/assets/js/47.81491902.js"><link rel="prefetch" href="/knowledge-system/assets/js/48.7b387717.js"><link rel="prefetch" href="/knowledge-system/assets/js/49.5c89a04e.js"><link rel="prefetch" href="/knowledge-system/assets/js/5.8da143bf.js"><link rel="prefetch" href="/knowledge-system/assets/js/50.e2be1fb4.js"><link rel="prefetch" href="/knowledge-system/assets/js/51.017ee426.js"><link rel="prefetch" href="/knowledge-system/assets/js/52.f2157c4c.js"><link rel="prefetch" href="/knowledge-system/assets/js/53.f5fa8cf5.js"><link rel="prefetch" href="/knowledge-system/assets/js/54.e0f1f50a.js"><link rel="prefetch" href="/knowledge-system/assets/js/55.ecba15b8.js"><link rel="prefetch" href="/knowledge-system/assets/js/56.b3f77242.js"><link rel="prefetch" href="/knowledge-system/assets/js/57.46b4a084.js"><link rel="prefetch" href="/knowledge-system/assets/js/58.a11590b8.js"><link rel="prefetch" href="/knowledge-system/assets/js/59.3ff89114.js"><link rel="prefetch" href="/knowledge-system/assets/js/6.6199361f.js"><link rel="prefetch" href="/knowledge-system/assets/js/60.7c4a655b.js"><link rel="prefetch" href="/knowledge-system/assets/js/61.d5a6f014.js"><link rel="prefetch" href="/knowledge-system/assets/js/62.51df8d81.js"><link rel="prefetch" href="/knowledge-system/assets/js/63.ce5dbd57.js"><link rel="prefetch" href="/knowledge-system/assets/js/64.20338a08.js"><link rel="prefetch" href="/knowledge-system/assets/js/65.80a2657f.js"><link rel="prefetch" href="/knowledge-system/assets/js/66.4e462475.js"><link rel="prefetch" href="/knowledge-system/assets/js/67.700be28c.js"><link rel="prefetch" href="/knowledge-system/assets/js/68.ee593e43.js"><link rel="prefetch" href="/knowledge-system/assets/js/69.fbf2ef6b.js"><link rel="prefetch" href="/knowledge-system/assets/js/7.017a2e0d.js"><link rel="prefetch" href="/knowledge-system/assets/js/70.4ae6afc2.js"><link rel="prefetch" href="/knowledge-system/assets/js/71.dda323e9.js"><link rel="prefetch" href="/knowledge-system/assets/js/72.3a9acced.js"><link rel="prefetch" href="/knowledge-system/assets/js/73.324b4464.js"><link rel="prefetch" href="/knowledge-system/assets/js/74.41bd108e.js"><link rel="prefetch" href="/knowledge-system/assets/js/75.5b93595f.js"><link rel="prefetch" href="/knowledge-system/assets/js/76.fb49fdf8.js"><link rel="prefetch" href="/knowledge-system/assets/js/77.e5673ef1.js"><link rel="prefetch" href="/knowledge-system/assets/js/78.1192f505.js"><link rel="prefetch" href="/knowledge-system/assets/js/79.b589bef4.js"><link rel="prefetch" href="/knowledge-system/assets/js/80.a0fa772e.js"><link rel="prefetch" href="/knowledge-system/assets/js/81.3133ffd2.js"><link rel="prefetch" href="/knowledge-system/assets/js/82.50396dae.js"><link rel="prefetch" href="/knowledge-system/assets/js/83.050842c6.js"><link rel="prefetch" href="/knowledge-system/assets/js/84.70d7334b.js"><link rel="prefetch" href="/knowledge-system/assets/js/85.26bc5610.js"><link rel="prefetch" href="/knowledge-system/assets/js/86.fb96dd67.js"><link rel="prefetch" href="/knowledge-system/assets/js/87.dc3738aa.js"><link rel="prefetch" href="/knowledge-system/assets/js/88.fed771de.js"><link rel="prefetch" href="/knowledge-system/assets/js/89.04f7f42a.js"><link rel="prefetch" href="/knowledge-system/assets/js/90.282cd237.js"><link rel="prefetch" href="/knowledge-system/assets/js/91.1b59293d.js"><link rel="prefetch" href="/knowledge-system/assets/js/92.4f084893.js"><link rel="prefetch" href="/knowledge-system/assets/js/93.e571b985.js"><link rel="prefetch" href="/knowledge-system/assets/js/94.146efa5e.js"><link rel="prefetch" href="/knowledge-system/assets/js/95.f373d964.js"><link rel="prefetch" href="/knowledge-system/assets/js/96.8904c2ea.js"><link rel="prefetch" href="/knowledge-system/assets/js/97.f0b4bc6a.js"><link rel="prefetch" href="/knowledge-system/assets/js/98.a7b327f6.js"><link rel="prefetch" href="/knowledge-system/assets/js/99.93df4d6b.js"><link rel="prefetch" href="/knowledge-system/assets/js/vendors~docsearch.1d5e679f.js">
    <link rel="stylesheet" href="/knowledge-system/assets/css/0.styles.1f67f494.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/knowledge-system/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/knowledge-system/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/knowledge-system/CSS/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/knowledge-system/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/knowledge-system/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/knowledge-system/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/knowledge-system/web3d/" class="nav-link">
  web3d
</a></div><div class="nav-item"><a href="/knowledge-system/AI/" class="nav-link">
  AI
</a></div><div class="nav-item"><a href="/knowledge-system/miniprogram/" class="nav-link">
  小程序
</a></div><div class="nav-item"><a href="/knowledge-system/hybrid/" class="nav-link">
  hybrid
</a></div><div class="nav-item"><a href="/knowledge-system/engineering/" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/knowledge-system/broswer/work/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/knowledge-system/scene/lottieUsage/" class="nav-link">
  沉淀
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/knowledge-system/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/knowledge-system/CSS/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/knowledge-system/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/knowledge-system/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/knowledge-system/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/knowledge-system/web3d/" class="nav-link">
  web3d
</a></div><div class="nav-item"><a href="/knowledge-system/AI/" class="nav-link">
  AI
</a></div><div class="nav-item"><a href="/knowledge-system/miniprogram/" class="nav-link">
  小程序
</a></div><div class="nav-item"><a href="/knowledge-system/hybrid/" class="nav-link">
  hybrid
</a></div><div class="nav-item"><a href="/knowledge-system/engineering/" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/knowledge-system/broswer/work/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/knowledge-system/scene/lottieUsage/" class="nav-link">
  沉淀
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/knowledge-system/scene/upload.html" class="sidebar-link">上传</a></li><li><a href="/knowledge-system/scene/lottieUsage.html" class="sidebar-link">lottie的应用场景</a></li><li><a href="/knowledge-system/scene/screenshoots.html" class="sidebar-link">前端截屏方案</a></li><li><a href="/knowledge-system/scene/modelViewer.html" class="sidebar-link">modelViewer</a></li><li><a href="/knowledge-system/scene/cli.html" class="sidebar-link">脚手架工具</a></li><li><a href="/knowledge-system/scene/vscode-extension.html" aria-current="page" class="active sidebar-link">vscode插件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#需求" class="sidebar-link">需求</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#项目目录制定" class="sidebar-link">项目目录制定</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#前置知识恶补" class="sidebar-link">前置知识恶补</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#进一步明确需求" class="sidebar-link">进一步明确需求</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#一些有用的-api" class="sidebar-link">一些有用的 API</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#各种有用的配置文件" class="sidebar-link">各种有用的配置文件</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#f5-调试插件时-干嘛了" class="sidebar-link">F5 调试插件时 干嘛了</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#vsce-publish-干嘛了" class="sidebar-link">vsce publish 干嘛了 ？</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#安装插件-又干嘛了" class="sidebar-link">安装插件 又干嘛了 ？</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#npm-publish-比-vsce-publish-简单多了" class="sidebar-link">npm publish 比 vsce publish 简单多了</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#npm-install" class="sidebar-link">npm install</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#插件开发插件第一阶段-基本功能" class="sidebar-link">插件开发插件第一阶段 基本功能</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#功能点" class="sidebar-link">功能点</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#插件开发插件第二阶段-功能优化" class="sidebar-link">插件开发插件第二阶段 功能优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#每个文件对应一个代码片段" class="sidebar-link">每个文件对应一个代码片段</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#代码片段分割" class="sidebar-link">代码片段分割</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#开发插件的第三阶段-架构优化" class="sidebar-link">开发插件的第三阶段 架构优化</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#目录再次调整" class="sidebar-link">目录再次调整</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#自动生成命令" class="sidebar-link">自动生成命令</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#开发插件第四阶段-配套文档" class="sidebar-link">开发插件第四阶段 配套文档</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#用-docusaurus" class="sidebar-link">用 docusaurus</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#自动生成文档" class="sidebar-link">自动生成文档</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#文档部署" class="sidebar-link">文档部署</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#演示" class="sidebar-link">演示</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#展望" class="sidebar-link">展望</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#在线搜索" class="sidebar-link">在线搜索</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#ai-赋能" class="sidebar-link">AI 赋能</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/scene/vscode-extension.html#心碎记录-to-myself" class="sidebar-link">心碎记录（to myself）</a></li></ul></li><li><a href="/knowledge-system/scene/pay.html" class="sidebar-link">支付</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="需求"><a href="#需求" class="header-anchor">#</a> 需求</h2> <p>实现一个工具函数库，可以通过 npm 包和 vscode 插件两种方式使用</p> <h4 id="工具函数库目录结构"><a href="#工具函数库目录结构" class="header-anchor">#</a> 工具函数库目录结构：</h4> <div class="language- extra-class"><pre class="language-text"><code>star-tools
├── validators
│   └── index.ts 计划把验证函数都放到这一个文件中
├── 3d
│   ├── control1.ts 因为 3d 类似 control 这种代码会比较长，是一个类，所以单独用文件
│   ├── control2.ts
│   └── index.ts 引入 control1、control2 等然后统一导出
└── ...
    ├── ...
    └── index.ts
</code></pre></div><h4 id="期望的-npm-包使用方式"><a href="#期望的-npm-包使用方式" class="header-anchor">#</a> 期望的 npm 包使用方式：</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>control1<span class="token punctuation">}</span> <span class="token string">'star-tools/3d'</span>
</code></pre></div><p>control1 拿到的就是 ts 源码</p> <h4 id="期望通过-vscode-插件使用的方式"><a href="#期望通过-vscode-插件使用的方式" class="header-anchor">#</a> 期望通过 vscode 插件使用的方式</h4> <ol><li>调出 vscode 命令面板</li> <li>每个函数对应一个命令，比如输入 star-tools:3d/control1，找到这个命令</li> <li>选中命令后 enter</li> <li>control1.ts 中的代码插入到当前工作区的 focus 处</li></ol> <h2 id="项目目录制定"><a href="#项目目录制定" class="header-anchor">#</a> 项目目录制定</h2> <p>两种方式在一个项目中，共用一份源码，主要是为了不维护双份的工具函数<br>
如果不考虑两种方式共用一个项目，</p> <h4 id="对于-npm-包引用的方式-目录结构"><a href="#对于-npm-包引用的方式-目录结构" class="header-anchor">#</a> 对于 npm 包引用的方式，目录结构：</h4> <div class="language- extra-class"><pre class="language-text"><code>star-tools
├── validators、3d、... 目录不变
├── .gitignore
└── package.json
</code></pre></div><p>直接 publish 源码，install 的就是源码，可以 import {control1} 'star-tools/3d' 引用到</p> <h4 id="vscode-插件目录结构"><a href="#vscode-插件目录结构" class="header-anchor">#</a> vscode 插件目录结构</h4> <div class="language- extra-class"><pre class="language-text"><code>star-tools
├── src
│   └── extension.ts 插件的入口文件，主要是插件的逻辑代码
├── tools
│   └── 省略，就是把三个分类文件夹直接移动过来
├── .gitignore
├── package.json
└── tsconfig.json
</code></pre></div><h4 id="结论"><a href="#结论" class="header-anchor">#</a> 结论</h4> <p>显而易见了，就直接用 vscode 插件的目录结构，这样直接 publish 源码仍然可以引用到工具函数，并且两种方式共用同一份 tools</p> <blockquote><p>目前来看，这样的目录结构虽然 ok，但是会有不合理的地方，比如要把只和 vscode 相关的部分也发布到了 npm，这个会在稍后解决。</p></blockquote> <h2 id="前置知识恶补"><a href="#前置知识恶补" class="header-anchor">#</a> 前置知识恶补</h2> <p>整个开发过程其实很不顺利，开发之前要先做一些调研，有一些前置知识会少走弯路。但很矛盾的是，一开始根本没有头绪，都不知道要先掌握哪些基本的前置知识。希望我总结的这些前置知识可以让你少走弯路咯 ~</p> <h3 id="进一步明确需求"><a href="#进一步明确需求" class="header-anchor">#</a> 进一步明确需求</h3> <p>在这个项目中：</p> <ul><li>由于插件的逻辑是用 ts 编写的，所以这部分代码需要编译为 js，因为 vscode 插件的运行时需要时 commonjs 模块规则</li> <li>作为 vscode 插件时：代码片段作为源码直接插入，不需要把 ts 编译为 js。</li> <li>作为 npm 包引用时：~~ 同上 ~~~</li></ul> <h3 id="一些有用的-api"><a href="#一些有用的-api" class="header-anchor">#</a> 一些有用的 API</h3> <ul><li>同步读取文件用 fs.readFileSync</li></ul> <h3 id="各种有用的配置文件"><a href="#各种有用的配置文件" class="header-anchor">#</a> 各种有用的配置文件</h3> <ul><li><p>package.json : 配置主入口、依赖、scripts 等、开发和发布后都要用到</p></li> <li><p>tsconfig.json : 负责把 ts 编译 为 js。vscode 插件运行时只能是 js，如果插件源码是 ts，tsconfig 是必要的（或者用一些其他的打包工具内部集成了 ts 编译为 js 的能力）</p></li> <li><p>.vscode 目录下的配置文件是用来配置 vscode 调试功能的，插件发布后无关。</p></li> <li><p>.npmignore 用来过滤发布到 npm 的文件。</p></li> <li><p>.vscodeignore 用来过滤发布到 <a href="https://marketplace.visualstudio.com/" target="_blank" rel="noopener noreferrer">marketplace<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 的文件。</p></li> <li><p>package.json 中的 scripts 脚本，&amp; 是并行，&amp;&amp; 是串联进行</p></li> <li><p>package.json 中的 dependencies 是运行时的依赖，对于 vscode 插件来说，安装插件时，自动安装。</p></li></ul> <h3 id="f5-调试插件时-干嘛了"><a href="#f5-调试插件时-干嘛了" class="header-anchor">#</a> F5 调试插件时 干嘛了</h3> <p>调试的入口文件为 .vscode/launch.json，一般情况下，vscode 左侧 debugger 工具面板都会自动定位到 .vscode/launch.json 中的 第一个命令<br> <img src="/knowledge-system/assets/img/vscode-ext-1.4178cf88.png" alt=""><br>
按下 f5 时，先经历了这样的过程，然后再把调试窗口启动<br> <img src="/knowledge-system/assets/img/vscode-ext-2.6f82fabb.png" alt=""><br>
原来 f5 并不神秘，就是 npm run dev 哇，实际执行的脚本在 star-tools 中是</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> run remove-out <span class="token operator">&amp;&amp;</span> tsc <span class="token operator">&amp;&amp;</span> <span class="token function">yarn</span> run move-src <span class="token operator">&amp;&amp;</span> <span class="token function">node</span> ./build/genVscdPkg.js
</code></pre></div><p>只看 tsc，它是负责把 ts 编译为 js 的，之后插件才能在 vscode 的环境中运行起来。编译之前会先读取 tsconfig.json 中的配置，然后开始编译并输出编译后的代码。</p> <blockquote><p>remove-out、move-src、node ./build/genVscdPkg.js 先不管，这些都属于对目录和文件内容的定制化处理。会在后面的优化中提到<br> <img src="/knowledge-system/assets/img/vscode-ext-3.4602e062.png" alt=""></p></blockquote> <ul><li>一般情况下 rootDir 都等同于当前目录所以是 './'</li> <li>includes 是参与编译的部分</li> <li>编译后输出到 out 目录下，out 目录下的文件与 src 下的对应</li> <li>配置 mapSource 为 true 方便调试，所以可以看到 out 目录下都有对应 .map.js</li></ul> <p>================== ok！上面编译阶段就完成了， ====================<br>
这时 vscode 就会把编译窗口启动，开始运行代码，再次看 package.json。其中 main 选项配置的文件就是运行时的入口文件</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./out/main.js&quot;</span><span class="token punctuation">,</span>
</code></pre></div><p>运行时就是插件的逻辑了，取决于插件的功能啦，star-tools 最开始的逻辑就是把每个工具函数都注册为命令，然后巴拉巴拉...(后面讲具体功能再说)</p> <h3 id="vsce-publish-干嘛了"><a href="#vsce-publish-干嘛了" class="header-anchor">#</a> vsce publish 干嘛了 ？</h3> <p>运行 vsce publish 命令后，经历了这样的过程：<br> <img src="/knowledge-system/assets/img/vscode-ext-4.3bc30a75.png" alt=" vsce publish 干嘛了 "></p> <ul><li>使用 yarn run esbuild-base 来编译，是因为 esbuild 这个打包工具在 tsc 的基础上有一些扩展功能比如压缩合并等，编译之前也是读取了 tsconfig 的配置。（其他也是针对项目的定制化处理，暂且不说）</li> <li>编译打包之后输出到 out 文件夹</li></ul> <p>============= 发布准备结束！下面就到发布阶段了 ==============<br>
（其实上面的流程也是编译阶段，和开发调试时不一样在于配置不同输出不同）</p> <ul><li>读取 .vscodeignore 对文件进行过滤</li> <li>发布到 marketplace</li></ul> <h3 id="安装插件-又干嘛了"><a href="#安装插件-又干嘛了" class="header-anchor">#</a> 安装插件 又干嘛了 ？</h3> <p>点击安装 =&gt; 下载发布到 marketplace 的插件源码 =&gt; 根据 package.json 中的 dependencies（‼️ 注意 ，要考的）安装依赖<br> <img src="/knowledge-system/assets/img/vscode-ext-5.3270712c.png" alt="安装vscode后"><br>
什么时候运行呢？由 package.json 中的配置项 activationEvents 决定</p> <ul><li>不配置或者为 [] ：当在命令面板中选择插件相关的命令时开始进入运行时</li> <li>配置为 * 号 ： vscode 启动就进入运行时</li></ul> <p>======================= 安装阶段 🔚 =========================</p> <p>运行时入口文件是 package.json 中的 main，接下来同开发调试时啦</p> <h3 id="npm-publish-比-vsce-publish-简单多了"><a href="#npm-publish-比-vsce-publish-简单多了" class="header-anchor">#</a> npm publish 比 vsce publish 简单多了</h3> <p><img src="/knowledge-system/assets/img/vscode-ext-6.ee344314.png" alt="npm publish"></p> <ul><li>不需要 tsc 编译了，因为就是发布源码，直接引用。（至于 node ./build/genNpmPkg 先不管，也是属于对目录和文件内容的定制化处理）</li></ul> <h3 id="npm-install"><a href="#npm-install" class="header-anchor">#</a> npm install</h3> <p>过滤后安装的包结构：</p> <div class="language- extra-class"><pre class="language-text"><code>根目录
├── tools
│   └── ... 源码结构
├── package.json
└── readme.md
</code></pre></div><h2 id="插件开发插件第一阶段-基本功能"><a href="#插件开发插件第一阶段-基本功能" class="header-anchor">#</a> 插件开发插件第一阶段 基本功能</h2> <h3 id="功能点"><a href="#功能点" class="header-anchor">#</a> 功能点</h3> <p><img src="/knowledge-system/assets/img/vscode-ext-7.9aa69474.png" alt=""><br>
从代码上来讲，图中三部分对应以下三段代码：</p> <h4 id="配置命令"><a href="#配置命令" class="header-anchor">#</a> 配置命令</h4> <ul><li>package.json</li></ul> <div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// ...</span>
<span class="token property">&quot;contributes&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;commands&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                <span class="token property">&quot;command&quot;</span><span class="token operator">:</span> <span class="token string">&quot;star-tools.3d.DeviceOrientationControls&quot;</span><span class="token punctuation">,</span>
                <span class="token property">&quot;title&quot;</span><span class="token operator">:</span> <span class="token string">&quot;star-tools: 3d相关/陀螺仪控制器&quot;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//...</span>
        <span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token comment">// ...</span>
</code></pre></div><h4 id="注册命令"><a href="#注册命令" class="header-anchor">#</a> 注册命令</h4> <ul><li>src/extension.ts</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">registerCommand</span> <span class="token operator">=</span>  <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">subName</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">methodFileName</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> fs<span class="token punctuation">.</span>PathLike</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> methodName <span class="token operator">=</span> methodFileName<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> commandName <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">star-tools.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>subName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>methodName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> content <span class="token operator">=</span>    <span class="token punctuation">(</span>method <span class="token keyword">as</span> string<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//processSourceFile 把文件作为字符串读取，逻辑省略</span>
  <span class="token keyword">return</span> vscode<span class="token punctuation">.</span>commands<span class="token punctuation">.</span><span class="token function">registerCommand</span><span class="token punctuation">(</span>commandName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">whenCommand</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">async</span> <span class="token keyword">function</span> <span class="token function">activate</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">context</span><span class="token operator">:</span> vscode<span class="token punctuation">.</span>ExtensionContext</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ... 读取目录逻辑省略</span>
  <span class="token comment">// subName 为分类名称如 “3d”</span>
  <span class="token comment">// methodFileName 为函数名称如 “DeviceOrientationControls.ts”</span>
  <span class="token comment">// method 为文件对应路径</span>
  context<span class="token punctuation">.</span>subscriptions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span> <span class="token function">registerCommand</span><span class="token punctuation">(</span>subName<span class="token punctuation">,</span> methodFileName<span class="token punctuation">,</span> method<span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="插入代码片段"><a href="#插入代码片段" class="header-anchor">#</a> 插入代码片段</h4> <ul><li>src/extension.js</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">whenCommand</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">methodName</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> editor <span class="token operator">=</span> vscode<span class="token punctuation">.</span>window<span class="token punctuation">.</span>activeTextEditor<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vscode<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">showWarningMessage</span><span class="token punctuation">(</span><span class="token string">&quot;star-tools: 工作区打开文件后才能使用该功能&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> selections <span class="token punctuation">}</span> <span class="token operator">=</span> editor<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>selections<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vscode<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">showWarningMessage</span><span class="token punctuation">(</span><span class="token string">&quot;star-tools: 请先选择一个区域&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> firstSelection <span class="token operator">=</span> selections<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> start<span class="token punctuation">,</span> end <span class="token punctuation">}</span> <span class="token operator">=</span> firstSelection<span class="token punctuation">;</span>
  <span class="token keyword">const</span> range <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vscode<span class="token punctuation">.</span>Range</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//计算选区范围</span>

  editor<span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">editBuilder</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    editBuilder<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> content<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//替换选区</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  vscode<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">showInformationMessage</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">✅ 已插入函数: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>methodName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="插件开发插件第二阶段-功能优化"><a href="#插件开发插件第二阶段-功能优化" class="header-anchor">#</a> 插件开发插件第二阶段 功能优化</h2> <p>做了一些规范化和自动化的事</p> <h3 id="每个文件对应一个代码片段"><a href="#每个文件对应一个代码片段" class="header-anchor">#</a> 每个文件对应一个代码片段</h3> <ul><li>符合封闭开放原则，对修改封闭，对增加开放,易于维护</li> <li>利于 AST 解析（后面会用到）</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">import</span> aaa <span class="token keyword">from</span> <span class="token string">'aaa'</span>  <span class="token comment">//也可以引用多个，或者没有依赖</span>
<span class="token comment">// 主体代码部分 start</span>
<span class="token keyword">type</span> <span class="token class-name">TXxx</span> <span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">bbb</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>

<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">xxx</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
   <span class="token function">bbb</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">// 主体代码部分 end</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> xxx <span class="token comment">//每个工具函数都有一个独立的文件，导出都用 export default</span>
</code></pre></div><h3 id="代码片段分割"><a href="#代码片段分割" class="header-anchor">#</a> 代码片段分割</h3> <p>vscode 插件的形式使用时，插入时，应该剔除 export 语句，并且将 import 插入顶部</p> <ol><li>改写 processSourceFile，加入 AST 解析逻辑</li></ol> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">processSourceFile</span><span class="token punctuation">(</span>filePath<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> sourceFile <span class="token operator">=</span> ts<span class="token punctuation">.</span><span class="token function">createSourceFile</span><span class="token punctuation">(</span>filePath<span class="token punctuation">,</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> ts<span class="token punctuation">.</span>ScriptTarget<span class="token punctuation">.</span>Latest<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> imports<span class="token operator">:</span> ts<span class="token punctuation">.</span>ImportDeclaration<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> exportDefault<span class="token operator">:</span> ts<span class="token punctuation">.</span>ExportAssignment <span class="token operator">|</span> <span class="token builtin">any</span> <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> otherStatements<span class="token operator">:</span> ts<span class="token punctuation">.</span>Statement<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token keyword">function</span> <span class="token function">findImportsAndExports</span><span class="token punctuation">(</span>node<span class="token operator">:</span> ts<span class="token punctuation">.</span>Node<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>ts<span class="token punctuation">.</span><span class="token function">isImportDeclaration</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      imports<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>ts<span class="token punctuation">.</span><span class="token function">isExportAssignment</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      exportDefault <span class="token operator">=</span> node<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      ts<span class="token punctuation">.</span><span class="token function">isStatement</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> otherStatements<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>node<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    ts<span class="token punctuation">.</span><span class="token function">forEachChild</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> findImportsAndExports<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  ts<span class="token punctuation">.</span><span class="token function">forEachChild</span><span class="token punctuation">(</span>sourceFile<span class="token punctuation">,</span> findImportsAndExports<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将import语句转为字符串</span>
  <span class="token keyword">let</span> importStr <span class="token operator">=</span> imports<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span>imp<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> sourceFile<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>imp<span class="token punctuation">.</span><span class="token function">getStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> imp<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将除了export和import之外的语句转为字符串</span>
  <span class="token keyword">let</span> bodyStart <span class="token operator">=</span> imports<span class="token punctuation">.</span>length <span class="token operator">?</span> imports<span class="token punctuation">[</span>imports<span class="token punctuation">.</span>length <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> bodyEnd <span class="token operator">=</span> exportDefault <span class="token operator">?</span> exportDefault<span class="token punctuation">.</span><span class="token function">getStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">:</span> sourceFile<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> bodyStr <span class="token operator">=</span> sourceFile<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>bodyStart<span class="token punctuation">,</span> bodyEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 将export语句转为字符串</span>
  <span class="token keyword">let</span> exportStr <span class="token operator">=</span> exportDefault <span class="token operator">?</span> sourceFile<span class="token punctuation">.</span>text<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>exportDefault<span class="token punctuation">.</span><span class="token function">getStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> exportDefault<span class="token punctuation">.</span><span class="token function">getEnd</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>

  <span class="token keyword">return</span> <span class="token punctuation">{</span> importStr<span class="token punctuation">,</span> bodyStr<span class="token punctuation">,</span> exportStr <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ol start="2"><li>改写 whenCommand</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">whenCommand</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">methodName</span><span class="token operator">:</span> string<span class="token punctuation">,</span> <span class="token literal-property property">content</span><span class="token operator">:</span> FileContent</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> editor <span class="token operator">=</span> vscode<span class="token punctuation">.</span>window<span class="token punctuation">.</span>activeTextEditor<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>editor<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vscode<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">showWarningMessage</span><span class="token punctuation">(</span><span class="token string">&quot;star-tools: 工作区打开文件后才能使用该功能&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> selections <span class="token punctuation">}</span> <span class="token operator">=</span> editor<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>selections<span class="token punctuation">.</span>length <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    vscode<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">showWarningMessage</span><span class="token punctuation">(</span><span class="token string">&quot;star-tools: 请先选择一个区域&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> firstSelection <span class="token operator">=</span> selections<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> start<span class="token punctuation">,</span> end <span class="token punctuation">}</span> <span class="token operator">=</span> firstSelection<span class="token punctuation">;</span>
  <span class="token keyword">const</span> range <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">vscode<span class="token punctuation">.</span>Range</span><span class="token punctuation">(</span>start<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>

  editor<span class="token punctuation">.</span><span class="token function">edit</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">editBuilder</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    editBuilder<span class="token punctuation">.</span><span class="token function">insert</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">vscode<span class="token punctuation">.</span>Position</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">,</span> content<span class="token punctuation">.</span>importStr <span class="token operator">+</span> <span class="token string">&quot;\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//引用</span>
    editBuilder<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>range<span class="token punctuation">,</span> content<span class="token punctuation">.</span>bodyStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//主体</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  vscode<span class="token punctuation">.</span>window<span class="token punctuation">.</span><span class="token function">showInformationMessage</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">✅ 已插入函数: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>methodName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="开发插件的第三阶段-架构优化"><a href="#开发插件的第三阶段-架构优化" class="header-anchor">#</a> 开发插件的第三阶段 架构优化</h2> <p>基于《目录结构制定》这一节，当前项目的结构是：</p> <div class="language- extra-class"><pre class="language-text"><code>star-tools
├── src
│   └── extension.ts 插件的入口文件，主要是插件的逻辑代码
├── tools
│   └── 省略，就是把三个分类文件夹直接移动过来
├── .gitignore
├── package.json
└── tsconfig.json
</code></pre></div><p>会有一些问题，我们接下来要解决：</p> <ul><li>npm 的使用方式和 vscode 插件的使用方式，发布时，package.json 不同。</li> <li>vsce publish 之前，需要在 package.json 的 contribute.commands 中手动配置命令。</li></ul> <h3 id="目录再次调整"><a href="#目录再次调整" class="header-anchor">#</a> 目录再次调整</h3> <p>vscode 插件使用方式和 npm 使用方式的 package.json 不同，应该拆分，调整后的目录为：</p> <div class="language- extra-class"><pre class="language-text"><code>star-tools
├── plugin
│   ├── build
│   ├── src
│   │   └── extension.ts  // 插件的入口文件，主要是插件的逻辑代码
│   ├── tools
│   │   └── 省略，就是把三个分类文件夹直接移动过来
│   ├── .vscodeignore
│   ├── tsconfig.json
│   ├── package.json
│   └── ...
├── npm
│   ├── package.json
│   ├── .npmignore
│   └── README.md
└── .gitignore
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// plugin/package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;star-tools&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;displayName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;star-tools&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;publisher&quot;</span><span class="token operator">:</span> <span class="token string">&quot;star-fe-developer-club&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.15&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;engines&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;vscode&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^1.84.0&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;categories&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;Other&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;activationEvents&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./out/main.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;contributes&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;commands&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token comment">// 省略，与tools下的文件一一对应</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yarn run remove-out &amp;&amp; tsc &amp;&amp; yarn run move-src &amp;&amp; node ./build/genVscdPkg.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;prod:vs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yarn run remove-out &amp;&amp; yarn run esbuild-base &amp;&amp; &amp;&amp; node ./build/genVscdPkg.js&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;vscode:prepublish&quot;</span><span class="token operator">:</span> <span class="token string">&quot;yarn run prod:vs&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;esbuild-base&quot;</span><span class="token operator">:</span> <span class="token string">&quot;esbuild ./src/main.ts --bundle --outfile=out/main.js --external:vscode --external:typescript --format=cjs --platform=node&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;remove-out&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rm -rf out&quot;</span><span class="token punctuation">,</span> <span class="token comment">//编译前先删掉已有的out</span>
    <span class="token property">&quot;move-src&quot;</span><span class="token operator">:</span> <span class="token string">&quot;mv out/src/** out &amp;&amp; rm -rf out/src&quot;</span> <span class="token comment">//开发环境编译后整理目录，out/src/extension.js 的 src 那层去掉（强迫症）</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 省略</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 与tools下代码片段的依赖无关，取决于src下插件源码用到的依赖</span>
    <span class="token property">&quot;typescript&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^5.3.3&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// npm/package.json</span>
<span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;tools_yxr&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.0.4&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;prepublish&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cp -r ../plugin/tools/utils .&quot;</span> <span class="token comment">//发布前把tools/utils拷贝过来</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 省略</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 取决于 utils 的依赖</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>npm 和 plugin 拆分，两个 package.json 不冲突，独自管理，差别直接看注释</li> <li>tools 放在 plugin 下面，因为 ① 只有 tools/utils 支持 npm 使用 ② 避免大量改动 extension 中的逻辑</li> <li>npm 发布前做一个拷贝操作。这样发布到 npm 的 utils 和 plugin 下的一样，不用维护两份。</li></ol> <h3 id="自动生成命令"><a href="#自动生成命令" class="header-anchor">#</a> 自动生成命令</h3> <p>vscode 插件使用时自动生成命令，插入 package.json。</p> <ul><li>package.json 中，开发和生产都有这段脚本 “&amp;&amp; node ./build/genVscdPkg.js”</li> <li>plugin/build/genVscdPkg.js 就是用来处理自动写入命令的</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// ...</span>
<span class="token comment">// getSubTitle 是通过简单的映射从英文到中文标题，类似有个这样的数据结构[[&quot;3d&quot;, &quot;3d相关&quot;], [&quot;validators&quot;, &quot;表单验证&quot;]]</span>
<span class="token comment">// parseContent 利用AST解析出代码片段中JSDOC中的代码片段标题</span>
<span class="token comment">// updateVersion 自动更新版本号</span>
pkg<span class="token punctuation">.</span>contributes<span class="token punctuation">.</span>commands <span class="token operator">=</span> methodFiles<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> subName<span class="token punctuation">,</span> methodFileName<span class="token punctuation">,</span> method <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> subTitle <span class="token operator">=</span> <span class="token function">getSubTitle</span><span class="token punctuation">(</span>subName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> name <span class="token operator">=</span> methodFileName<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">&quot;.ts&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> title <span class="token operator">=</span> <span class="token function">parseContent</span><span class="token punctuation">(</span>method<span class="token punctuation">)</span><span class="token punctuation">.</span>title <span class="token operator">||</span> name<span class="token punctuation">;</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;⭐️ 生成命令&quot;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">star-tools.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>subName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token string">&quot;=&gt;&quot;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">star-tools: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>subTitle<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">command</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">star-tools.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>subName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
    <span class="token literal-property property">title</span><span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">star-tools: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>subTitle<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>title<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span><span class="token string">&quot;./package.json&quot;</span><span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>pkg<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;✅ package.json 写入完成 ⚙⚙⚙&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="开发插件第四阶段-配套文档"><a href="#开发插件第四阶段-配套文档" class="header-anchor">#</a> 开发插件第四阶段 配套文档</h2> <h3 id="用-docusaurus"><a href="#用-docusaurus" class="header-anchor">#</a> 用 docusaurus</h3> <p>在原有的架构上多一个 website 目录，与 plugin 和 npm 隔离</p> <div class="language- extra-class"><pre class="language-text"><code>star-tools
├── ... 不变
└── website（新增）
    ├── scripts
    ├   ├── template.md
    ├   └── genDocs.js
    ├── package.json
    ├── docs 文档目录
    └── ... 其他结构参考 docusaurus
</code></pre></div><p>其他结构参考 docusaurus <a href="https://codesandbox.io/p/devbox/beautiful-archimedes-qdeo7" target="_blank" rel="noopener noreferrer">官方 demo<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="自动生成文档"><a href="#自动生成文档" class="header-anchor">#</a> 自动生成文档</h3> <ol><li>预设文档模板 website/scripts/template.md</li></ol> <p><img src="/knowledge-system/assets/img/vscode-ext-8.04745d4c.png" alt="template"></p> <ol start="2"><li>website/package.json 添加命令</li></ol> <p>贡献者（开发者）在添加代码片段后需要用命令去生成文档，可以是一个目录，也可以是一个文件，也可以全量更新，会根据参数解析。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> run create-docs <span class="token assign-left variable">path</span><span class="token operator">=</span>/3d/SpaceHelper.ts <span class="token comment"># 拿一个文件举例子</span>
</code></pre></div><div class="language-json extra-class"><pre class="language-json"><code><span class="token comment">// ...</span>
<span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
 <span class="token property">&quot;create-docs&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node ./scripts/genDocs.js&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token comment">// ...</span>
</code></pre></div><ol start="3"><li>website/scripts/genDocs.js 读取模板，替换占位符</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// createAllDocs 较为简单，不放代码了</span>
<span class="token comment">// createCategory 较为简单，不放代码了</span>
<span class="token comment">// parseContent 再次用到 AST，分析出代码片段源文件中的 JSDoc，</span>
<span class="token keyword">const</span> <span class="token function-variable function">createMethodDoc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> subName<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> method <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> subTitle <span class="token operator">=</span> <span class="token function">getSubTitle</span><span class="token punctuation">(</span>subName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 获取子标题</span>
  <span class="token keyword">const</span> mdPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">../docs/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>subName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>methodName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.md</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 构造 Markdown 文件路径</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>fs<span class="token punctuation">.</span><span class="token function">existsSync</span><span class="token punctuation">(</span>mdPath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>mdPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token comment">// 如果 Markdown 文件已存在，删除它</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> title<span class="token punctuation">,</span> description<span class="token punctuation">,</span> parameters<span class="token punctuation">,</span> returns<span class="token punctuation">,</span> properties <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">parseContent</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> methodName<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 解析方法内容，获取标题、描述、参数、返回值和属性</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;⭐️ 生成文档&quot;</span><span class="token punctuation">,</span> mdPath<span class="token punctuation">,</span> <span class="token string">&quot;:\n&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 打印生成文档的信息</span>
  <span class="token keyword">const</span> template <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./template.md&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;utf8&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 读取模板文件</span>
  <span class="token keyword">let</span> mdStr <span class="token operator">=</span> template <span class="token comment">// 替换模板中的占位符 start</span>
    <span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">@methodName</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> methodName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...  省略</span>
  <span class="token comment">// 替换模板中的占位符 end</span>
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>mdPath<span class="token punctuation">,</span> mdStr<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 写入生成的 Markdown 字符串到文件</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token function-variable function">parseScript</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 打印命令行参数的第二个值</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;process.argv[2]:&quot;</span><span class="token punctuation">,</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 如果没有提供命令行参数的第二个值，那么生成所有文档</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">createAllDocs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// 从命令行参数的第二个值中获取路径字符串</span>
  <span class="token keyword">const</span> pathStr <span class="token operator">=</span> process<span class="token punctuation">.</span>argv<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;=&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

  <span class="token comment">// 构造源代码路径和 Markdown 文档路径</span>
  <span class="token keyword">const</span> sourceCodePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../../plugin/tools&quot;</span> <span class="token operator">+</span> pathStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> mdDocPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;../docs&quot;</span> <span class="token operator">+</span> pathStr<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 获取源代码路径的文件或目录状态</span>
  <span class="token keyword">const</span> stats <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>sourceCodePath<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// 检查 sourceCodePath 是文件夹还是文件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是目录，获取目录名作为子分类名，然后创建该子分类的文档</span>
    <span class="token keyword">const</span> subName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>sourceCodePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">createCategory</span><span class="token punctuation">(</span>subName<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>stats<span class="token punctuation">.</span><span class="token function">isFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果是文件，获取文件名和其所在目录名，然后创建该方法的文档</span>
    <span class="token keyword">const</span> methodFileName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>sourceCodePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> subName <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">basename</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">dirname</span><span class="token punctuation">(</span>sourceCodePath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">createMethodDoc</span><span class="token punctuation">(</span><span class="token punctuation">{</span> subName<span class="token punctuation">,</span> <span class="token literal-property property">methodName</span><span class="token operator">:</span> methodFileName<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">method</span><span class="token operator">:</span> sourceCodePath <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果既不是文件也不是目录，打印错误信息</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;❌ 文件或目录路径不正确：&quot;</span><span class="token punctuation">,</span> sourceCodePath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token function">parseScript</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="文档部署"><a href="#文档部署" class="header-anchor">#</a> 文档部署</h3> <p>docusaurus 集成了打包的能力，package.json 中预置的命令就够用了。</p> <ul><li>npm run dev 本地启动</li> <li>npm run build 生产环境打包部署用</li></ul> <h2 id="演示"><a href="#演示" class="header-anchor">#</a> 演示</h2> <p><img src="/knowledge-system/assets/img/vscode-ext-9.9be90294.gif" alt=""></p> <h2 id="展望"><a href="#展望" class="header-anchor">#</a> 展望</h2> <h3 id="在线搜索"><a href="#在线搜索" class="header-anchor">#</a> 在线搜索</h3> <p>随着代码片段数量的增长，这种方式可能会带来一些问题。</p> <ul><li>安装我们的 VS Code 插件时，所有的代码片段都会被下载到用户的本地空间，浪费资源。</li> <li>需要添加、删除或修改代码片段时，可能需要频繁地修改项目文件，频繁发版。</li></ul> <p>因此，考虑将代码片段存储在后端数据库中，通过接口请求搜索代码片段。</p> <h3 id="ai-赋能"><a href="#ai-赋能" class="header-anchor">#</a> AI 赋能</h3> <p>从需求定位到代码片段会有个问题：有些用户可能清楚自己的需求，但是无法准确地提炼出能够定位到特定代码片段的关键词。<br>
为了解决这个问题，计划利用大语言模型的能力来帮助用户定位到他们需要的代码片段。<br>
目前是想要用 langchain。大致思路是：</p> <ul><li>用 Langchain 的 Text Splitters 将命令描述信息分割成块，命令名称就不用分割了因为很短.</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> RecursiveCharacterTextSplitter <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;langchain/text_splitter&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> splitter <span class="token operator">=</span> RecursiveCharacterTextSplitter<span class="token punctuation">.</span><span class="token function">fromLanguage</span><span class="token punctuation">(</span><span class="token string">&quot;js&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">chunkSize</span><span class="token operator">:</span> <span class="token number">32</span><span class="token punctuation">,</span>
  <span class="token literal-property property">chunkOverlap</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> jsOutput <span class="token operator">=</span> <span class="token keyword">await</span> splitter<span class="token punctuation">.</span><span class="token function">createDocuments</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;代码片段&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>用 Langchain 的 FaissStore 和 OpenAIEmbeddings 来创建一个向量数据库。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> FaissStore <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;langchain/vectorstores/faiss&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> OpenAIEmbeddings <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;langchain/embeddings&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> embedding <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpenAIEmbeddings</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 使用OpenAI的embedding模型</span>
<span class="token keyword">const</span> vectorStore <span class="token operator">=</span> <span class="token keyword">await</span> FaissStore<span class="token punctuation">.</span><span class="token function">fromTexts</span><span class="token punctuation">(</span>jsOutput<span class="token punctuation">,</span> metadata<span class="token punctuation">,</span> embedding<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//metadata 为和 doc 相关联的元信息（比如说对应原文第n行数据，相关联的对象等等）若不需要直接传output也可以。</span>
</code></pre></div><ul><li>用向量数据库的向量搜索能力（similarity Search WithStore）把用户需求文本作为入参，来匹配命令进而得到代码块</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> searchRes <span class="token operator">=</span> <span class="token keyword">await</span> vectorStore<span class="token punctuation">.</span><span class="token function">similaritySearchWithScore</span><span class="token punctuation">(</span>prompt<span class="token punctuation">,</span> topK<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//prompt 是用户输入，topK控制匹配结果数</span>
</code></pre></div><ul><li>后续内容变多，需要结合 Langchain 的 APIChain 能力，在线搜索。</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> OpenAI <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;langchain/llms/openai&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> APIChain <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;langchain/chains&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token constant">OPEN_METEO_DOCS</span> <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">BASE URL: 接口地址</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">const</span> model <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">OpenAI</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> chain <span class="token operator">=</span> APIChain<span class="token punctuation">.</span><span class="token function">fromLLMAndAPIDocs</span><span class="token punctuation">(</span>model<span class="token punctuation">,</span> <span class="token constant">OPEN_METEO_DOCS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">chain</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">question</span><span class="token operator">:</span> <span class="token string">&quot;关键词&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> res <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="心碎记录-to-myself"><a href="#心碎记录-to-myself" class="header-anchor">#</a> 心碎记录（to myself）</h2> <ul><li>没有这个意识：只有插件运行时的逻辑代码需要编译，代码片段不需要编译。并且不知道以文本形式读取代码片段应该用哪个 API。向 gpt 询问的时候，由于不明确这一点，导致误导越来越深。又是装 babel 又是配置的，浪费了三个小时。最后插入的代码是编译后的，才恍然大悟，自己一开始的意识是错的。</li> <li>由于 tsconfig 配置不熟悉，不知道 esbuild 这个打包工具。一开始输出的是 out/src/extension.js，最后调整为 out/main.js 的过程也很坎坷，做了一下无用功，比如写脚本还有通过 copyfiles 去整理 out 目录之类的。</li> <li>由于不知道.vscodeignore 配置文件（关键是 vsce publish 的时候过滤了所有 ts 文件），导致发布时没有 tools 文件夹，在生产环境使用插件时注册命令的逻辑就出错了</li> <li>由于不知道.npmignore，一开始发布的 npm 包，包含了很多无用代码</li> <li>由于忘记了 typescrpt 是在运行时也用到的， dependencies 没放这个依赖，而是放到 devDependencies，开发调试没问题，别人安装插件使用时就有问题</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/knowledge-system/scene/cli.html" class="prev">
        脚手架工具
      </a></span> <span class="next"><a href="/knowledge-system/scene/pay.html">
        支付
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/knowledge-system/assets/js/app.744a76bb.js" defer></script><script src="/knowledge-system/assets/js/2.2562ca4f.js" defer></script><script src="/knowledge-system/assets/js/1.8b017304.js" defer></script><script src="/knowledge-system/assets/js/16.ddb321b8.js" defer></script>
  </body>
</html>
