<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VuePress</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="image/logo.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/knowledge-system/assets/css/0.styles.103185be.css" as="style"><link rel="preload" href="/knowledge-system/assets/js/app.714e5304.js" as="script"><link rel="preload" href="/knowledge-system/assets/js/2.7dc4c8b6.js" as="script"><link rel="preload" href="/knowledge-system/assets/js/81.e32e5881.js" as="script"><link rel="prefetch" href="/knowledge-system/assets/js/10.3cd1ac0a.js"><link rel="prefetch" href="/knowledge-system/assets/js/11.1f0c020c.js"><link rel="prefetch" href="/knowledge-system/assets/js/12.3cfc29e1.js"><link rel="prefetch" href="/knowledge-system/assets/js/13.1a7b4dbb.js"><link rel="prefetch" href="/knowledge-system/assets/js/14.ea8bf876.js"><link rel="prefetch" href="/knowledge-system/assets/js/15.47ce5ddc.js"><link rel="prefetch" href="/knowledge-system/assets/js/16.6315a77c.js"><link rel="prefetch" href="/knowledge-system/assets/js/17.6b17a8c3.js"><link rel="prefetch" href="/knowledge-system/assets/js/18.4a402bb3.js"><link rel="prefetch" href="/knowledge-system/assets/js/19.5d3044cc.js"><link rel="prefetch" href="/knowledge-system/assets/js/20.34c8a3bd.js"><link rel="prefetch" href="/knowledge-system/assets/js/21.68eb87ef.js"><link rel="prefetch" href="/knowledge-system/assets/js/22.d7dedf80.js"><link rel="prefetch" href="/knowledge-system/assets/js/23.fbe53115.js"><link rel="prefetch" href="/knowledge-system/assets/js/24.2eb5b0a4.js"><link rel="prefetch" href="/knowledge-system/assets/js/25.f33fd987.js"><link rel="prefetch" href="/knowledge-system/assets/js/26.0f0c6b6d.js"><link rel="prefetch" href="/knowledge-system/assets/js/27.df4e53d4.js"><link rel="prefetch" href="/knowledge-system/assets/js/28.a91a9f48.js"><link rel="prefetch" href="/knowledge-system/assets/js/29.930754f7.js"><link rel="prefetch" href="/knowledge-system/assets/js/3.e98df960.js"><link rel="prefetch" href="/knowledge-system/assets/js/30.36817a58.js"><link rel="prefetch" href="/knowledge-system/assets/js/31.23f06199.js"><link rel="prefetch" href="/knowledge-system/assets/js/32.d5086c64.js"><link rel="prefetch" href="/knowledge-system/assets/js/33.486ded50.js"><link rel="prefetch" href="/knowledge-system/assets/js/34.c7f60886.js"><link rel="prefetch" href="/knowledge-system/assets/js/35.29ebd85a.js"><link rel="prefetch" href="/knowledge-system/assets/js/36.c1cc10b1.js"><link rel="prefetch" href="/knowledge-system/assets/js/37.5c1be313.js"><link rel="prefetch" href="/knowledge-system/assets/js/38.fc78e723.js"><link rel="prefetch" href="/knowledge-system/assets/js/39.139a8972.js"><link rel="prefetch" href="/knowledge-system/assets/js/4.f7e4cda9.js"><link rel="prefetch" href="/knowledge-system/assets/js/40.86a2f9bd.js"><link rel="prefetch" href="/knowledge-system/assets/js/41.4a3de39e.js"><link rel="prefetch" href="/knowledge-system/assets/js/42.9ae85e2b.js"><link rel="prefetch" href="/knowledge-system/assets/js/43.e2a48139.js"><link rel="prefetch" href="/knowledge-system/assets/js/44.689a974a.js"><link rel="prefetch" href="/knowledge-system/assets/js/45.475bfab5.js"><link rel="prefetch" href="/knowledge-system/assets/js/46.a767a700.js"><link rel="prefetch" href="/knowledge-system/assets/js/47.d9cad9dd.js"><link rel="prefetch" href="/knowledge-system/assets/js/48.d98b9d73.js"><link rel="prefetch" href="/knowledge-system/assets/js/49.1e9754b0.js"><link rel="prefetch" href="/knowledge-system/assets/js/5.f7415623.js"><link rel="prefetch" href="/knowledge-system/assets/js/50.9b9d16d2.js"><link rel="prefetch" href="/knowledge-system/assets/js/51.b9e4acd8.js"><link rel="prefetch" href="/knowledge-system/assets/js/52.660ac118.js"><link rel="prefetch" href="/knowledge-system/assets/js/53.79f9d722.js"><link rel="prefetch" href="/knowledge-system/assets/js/54.d5dc1a34.js"><link rel="prefetch" href="/knowledge-system/assets/js/55.7ed246e1.js"><link rel="prefetch" href="/knowledge-system/assets/js/56.8721d5ce.js"><link rel="prefetch" href="/knowledge-system/assets/js/57.c50ca4e9.js"><link rel="prefetch" href="/knowledge-system/assets/js/58.edcefda7.js"><link rel="prefetch" href="/knowledge-system/assets/js/59.b380e9e4.js"><link rel="prefetch" href="/knowledge-system/assets/js/6.67148f7d.js"><link rel="prefetch" href="/knowledge-system/assets/js/60.bf20a516.js"><link rel="prefetch" href="/knowledge-system/assets/js/61.f9d9f7fd.js"><link rel="prefetch" href="/knowledge-system/assets/js/62.0faa0619.js"><link rel="prefetch" href="/knowledge-system/assets/js/63.9194c352.js"><link rel="prefetch" href="/knowledge-system/assets/js/64.5d5671c2.js"><link rel="prefetch" href="/knowledge-system/assets/js/65.8de437dc.js"><link rel="prefetch" href="/knowledge-system/assets/js/66.d14d8353.js"><link rel="prefetch" href="/knowledge-system/assets/js/67.6debd2ed.js"><link rel="prefetch" href="/knowledge-system/assets/js/68.dce632ea.js"><link rel="prefetch" href="/knowledge-system/assets/js/69.ff900245.js"><link rel="prefetch" href="/knowledge-system/assets/js/7.4616fabc.js"><link rel="prefetch" href="/knowledge-system/assets/js/70.662fb310.js"><link rel="prefetch" href="/knowledge-system/assets/js/71.d05ef484.js"><link rel="prefetch" href="/knowledge-system/assets/js/72.87b5a27e.js"><link rel="prefetch" href="/knowledge-system/assets/js/73.1d3e5940.js"><link rel="prefetch" href="/knowledge-system/assets/js/74.b0a505b3.js"><link rel="prefetch" href="/knowledge-system/assets/js/75.fbf9ba52.js"><link rel="prefetch" href="/knowledge-system/assets/js/76.50354f5d.js"><link rel="prefetch" href="/knowledge-system/assets/js/77.8e05afc8.js"><link rel="prefetch" href="/knowledge-system/assets/js/78.4be4a9bc.js"><link rel="prefetch" href="/knowledge-system/assets/js/79.a7b65e50.js"><link rel="prefetch" href="/knowledge-system/assets/js/8.36a32838.js"><link rel="prefetch" href="/knowledge-system/assets/js/80.e784b039.js"><link rel="prefetch" href="/knowledge-system/assets/js/82.e1a28ad9.js"><link rel="prefetch" href="/knowledge-system/assets/js/83.941dfaef.js"><link rel="prefetch" href="/knowledge-system/assets/js/9.3c66ddc9.js">
    <link rel="stylesheet" href="/knowledge-system/assets/css/0.styles.103185be.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/knowledge-system/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/knowledge-system/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/knowledge-system/CSS/layout/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/knowledge-system/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/knowledge-system/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/knowledge-system/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/knowledge-system/broswer/work/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/knowledge-system/engineering/" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/knowledge-system/scene/lottieUsage/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/knowledge-system/web3d/" class="nav-link router-link-active">
  web3d
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/knowledge-system/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/knowledge-system/CSS/layout/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/knowledge-system/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/knowledge-system/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/knowledge-system/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/knowledge-system/broswer/work/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/knowledge-system/engineering/" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/knowledge-system/scene/lottieUsage/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/knowledge-system/web3d/" class="nav-link router-link-active">
  web3d
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/knowledge-system/web3d/demoStart/" class="sidebar-link">3d入门之空间与模型</a></li><li><a href="/knowledge-system/web3d/demoInteraction/" class="sidebar-link">3d入门之交互</a></li><li><a href="/knowledge-system/web3d/PORender/" class="sidebar-link">web3d性能优化-渲染</a></li><li><a href="/knowledge-system/web3d/POLoad/" class="sidebar-link">web3d性能优化-加载</a></li><li><a href="/knowledge-system/web3d/ARStart/" aria-current="page" class="active sidebar-link">入门AR</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#核心技术及相关技术栈" class="sidebar-link">核心技术及相关技术栈</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#读取" class="sidebar-link">读取</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#识别与跟踪" class="sidebar-link">识别与跟踪</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#渲染" class="sidebar-link">渲染</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#技术方案-🍱" class="sidebar-link">技术方案 🍱</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#项目实践" class="sidebar-link">项目实践</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#微信小程序中的-ar-平面检测能力" class="sidebar-link">微信小程序中的 AR 平面检测能力</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#代码流程" class="sidebar-link">代码流程</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#难点-or-坑点" class="sidebar-link">难点 or 坑点</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#模型效果-阴影等" class="sidebar-link">模型效果（阴影等）</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#向后兼容" class="sidebar-link">向后兼容</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#内存问题解决" class="sidebar-link">内存问题解决</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#重置-平面检测后重新放置模型-与平移" class="sidebar-link">重置（平面检测后重新放置模型）与平移</a></li></ul></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>AR 增强现实，是指在真实世界的基础上，通过计算机生成的虚拟信息，将虚拟信息与真实世界进行融合，从而达到增强现实的效果。</p> <h2 id="核心技术及相关技术栈"><a href="#核心技术及相关技术栈" class="header-anchor">#</a> 核心技术及相关技术栈</h2> <p>想要实现 WebAR 效果，四个步骤：读取、识别、跟踪、渲染。<br>
拿扫福举 🌰：
打开相机画面（读取）、扫到福字（识别）、渲染虚拟场景比如小兔子跳出来的动画（渲染）</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d3f0b5cad4604cb3857b8686ea9d7318~tplv-k3u1fbpfcp-watermark.image?" alt="0.png">
技术上说，粗略流程：</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7d806526f704576adc875ac1a41f199~tplv-k3u1fbpfcp-watermark.image?" alt="1.png"></p> <p>技术栈：</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dd1875af0b6d45e68a5e19c5b62a412d~tplv-k3u1fbpfcp-watermark.image?" alt="5.png"></p> <h3 id="读取"><a href="#读取" class="header-anchor">#</a> 读取</h3> <ul><li><p>浏览器中：WebRTC.js，最关键的 API 方法是 getUserMedia() ，实时获取摄像头的视频流</p></li> <li><p>微信小程序中：腾讯视频云的 liteavsdk</p></li></ul> <blockquote><p><a href="https://developers.weixin.qq.com/community/develop/article/doc/0008ae6f288ee85cb1f7344f35b413" target="_blank" rel="noopener noreferrer">微信官方总结两者区别<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="识别与跟踪"><a href="#识别与跟踪" class="header-anchor">#</a> 识别与跟踪</h3> <p>浏览器中可用的库 ： JSARToolKit、Tracking.js、jsFeat、js-aruco</p> <ul><li>JSARToolKit（1999 年发布，一直更新至今） 和 js-aruco 都是基于特定的标记去跟踪的，而不能像 Tracking.js 那样进行特征检测。它们依赖于事先印刷好的标记，通过检测标记的位置和方向，从而定位和跟踪物体。在使用这些库时，需要将标记嵌入到需要跟踪的物体上，因此它们更适用于需要定向和固定跟踪的应用场景。</li> <li>Tracking.js 和 jsFeat 等库则使用计算机视觉算法进行特征检测和跟踪，可以在图像中检测和跟踪目标对象，而不需要特定的标记。这些库更适用于需要动态跟踪的场景，例如手势识别、人体识别等应用。不过对于 web 端来说，算力可能跟不上。</li></ul> <p>微信小程序中可用的库：</p> <ul><li>Vision Kit 是一个使用一些深度学习框架 （如 TensorFlow） 进行深度学习的训练和推断，结合一些计算机视觉算法（如 OpenCV），形成的识别追踪库。具备：平面检测、人脸识别、手势识别、跟踪等能力。
<blockquote><p>AR 中最难部分就是跟踪</p></blockquote></li></ul> <h3 id="渲染"><a href="#渲染" class="header-anchor">#</a> 渲染</h3> <p>浏览器中可用的库：Three.js、Babylon.js、playCanvas、pixi.js(2d)</p> <ul><li><a href="https://threejs.org/" target="_blank" rel="noopener noreferrer">Three.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是最早出现的 WebGL 库之一，提供了丰富的 3D 渲染和动画功能，支持多种 3D 模型格式和材质。</li> <li><a href="https://www.babylonjs.com/" target="_blank" rel="noopener noreferrer">Babylon.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是由微软开发的 3D 游戏引擎，也提供了类似的 3D 渲染和动画功能，并支持物理引擎和多人游戏等高级特性。</li> <li><a href="https://playcanvas.com/" target="_blank" rel="noopener noreferrer">playCanvas<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 则是一款基于 WebGL 的在线游戏开发平台，提供了完整的游戏开发工具和游戏发布服务，可以方便地在 Web 浏览器中创建和发布高品质的 3D 游戏。</li></ul> <p>微信小程序中可用的库，几乎都是 three 的微信小程序定制版：</p> <ul><li><a href="https://github.com/yannliao/threejs.miniprogram" target="_blank" rel="noopener noreferrer">three.weapp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/wechat-miniprogram/threejs-miniprogram" target="_blank" rel="noopener noreferrer">threejs-miniprogram<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/amorwilliams/threejs-wx" target="_blank" rel="noopener noreferrer">threejs-wx<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="技术方案-🍱"><a href="#技术方案-🍱" class="header-anchor">#</a> 技术方案 🍱</h3> <p>在 web 端（包括小程序）实现完整的 AR 能力，有哪些技术方案呢？</p> <table><thead><tr><th>方案 and 能力</th> <th>特定图像识别</th> <th>特征检测</th> <th>性能</th></tr></thead> <tbody><tr><td>AR.js（WebRTC+JSARToolKit+Three.js/Babylon.js/A-Frame）</td> <td>✔️</td> <td>×</td> <td>✔️</td></tr> <tr><td>WebRTC + trackingJS + ThreeJS</td> <td>✔️</td> <td>✔️</td> <td>×</td></tr> <tr><td>video 标签 + ThreeJS + 陀螺仪</td> <td>×</td> <td>×</td> <td>✔️</td></tr> <tr><td>微信小程序 vision kit + threejs-miniprogram</td> <td>✔️</td> <td>✔️</td> <td>✔️</td></tr> <tr><td>其他小程序</td> <td>？</td> <td>？</td> <td>？</td></tr></tbody></table> <h2 id="项目实践"><a href="#项目实践" class="header-anchor">#</a> 项目实践</h2> <p>关键点：① 识别现实世界中的平面，将一个 3D 人物模型“放置”在平面上。 ②3D 经灯光照射有阴影效果，③ 对 3D 模型可进行简单的平移、旋转、缩放操作以便于完成虚拟人物与现实中的人合影。<br>
因为需要 “识别现实世界中的水平面”，也就是说需要特征检测，所以最（wu🤷🏻‍♀️）后（nai🤷‍♂️）选择了微信小程序，采用 vision kit + threejs-miniprogram 的技术方案。</p> <h2 id="微信小程序中的-ar-平面检测能力"><a href="#微信小程序中的-ar-平面检测能力" class="header-anchor">#</a> 微信小程序中的 AR 平面检测能力</h2> <p>vision kit 有 v1 v2 两个版本，高版本不一定更好哦，下面先介绍一下差异性。
<img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc2c9e5734044d14a767cc9c15114126~tplv-k3u1fbpfcp-watermark.image?" alt="2.png"></p> <h4 id="⭐️-api-能力"><a href="#⭐️-api-能力" class="header-anchor">#</a> ⭐️ API（能力）</h4> <p>v2 肯定比 v1 多喽～</p> <ul><li>v1 调用 hitTest 进行平面检测。</li> <li>v2 除了 hitTest，还增加了实时监听平面的功能，事件有：'addAnchors'、'updateAnchors'、'removeAnchors'</li> <li>v1 只能检测水平面</li> <li>v2 除了水平面，也可以识别竖平面</li></ul> <h4 id="⛓-稳定性"><a href="#⛓-稳定性" class="header-anchor">#</a> ⛓ 稳定性</h4> <p>v1 版本不如 v2 版本稳定。</p> <ul><li>v1 版本有动态物体从镜头前经过就会把 3D 模型带走，v2 版本不会。</li> <li>但当镜头晃动速率较高的时候，不论哪个版本，模型还是会漂移。</li></ul> <blockquote><p>以上是实践总结，以下是官方说法<br>
V1 版，当手机摄像头没有朝向地面时，3D 模型会漂移、忽大忽小、无法停留在开始的位置。原因是 AR 以地面为跟踪目标，如果地面从手机画面中消失，V1 版 AR 就无法正常运行。<br>
V2 版，AR 以房间环境为跟踪目标，不会因为手机姿态造成 3D 模型漂移。但遮住手机摄像头，V2 版 AR 也无法正常运行。</p></blockquote> <h4 id="准确性与成功率"><a href="#准确性与成功率" class="header-anchor">#</a> 准确性与成功率</h4> <p>v2 检测准确性高于 v1，但成功率低于 v1，具体难度取决于手机。<br>
通过项目实践的经验，个人认为原因是：</p> <ul><li>v2 是真的检测现实中的平面，如果对准的位置是墙，那一定是检测不到的（准确高），但有些手机对准地面可能需要手机放平才检测到（难度高）。</li> <li>v1 之所以容易，是因为 v1 并没有识别现实场景，而是直接去生成一个水平面。所以 v1 几乎每次都成功（难度低），但手机不对着地面的时候，模型会悬空（准确低）。</li></ul> <h4 id="兼容性"><a href="#兼容性" class="header-anchor">#</a> 兼容性</h4> <p>开发期间调研，iphone 8 以上均支持 v2 版本，Android 很少部分支持 v2。（项目线上数据待统计，不知道能否公开）</p> <blockquote><p>官方数据：
<a href="https://zhuanlan.zhihu.com/p/544052686" target="_blank" rel="noopener noreferrer">对微信版本要求、不同手机支持程度<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h4 id="世界坐标系原点的变化"><a href="#世界坐标系原点的变化" class="header-anchor">#</a> 世界坐标系原点的变化</h4> <ul><li>v1 以识别成功的平面中心点，为世界坐标系原点。也就是说每次 hitTest 世界坐标的原点都更新了。</li> <li>v2 以手机相机的开始位置，为世界坐标系原点。也就是说 createVkSession 运行成功的瞬间，出现相机画面，屏幕中心点为世界坐标原点。后面 hitTest 再也不变了。</li></ul> <h2 id="代码流程"><a href="#代码流程" class="header-anchor">#</a> 代码流程</h2> <p>针对<a href="https://developers.weixin.qq.com/miniprogram/dev/framework/open-ability/visionkit/base.html" target="_blank" rel="noopener noreferrer">官方代码<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>流程画个图吧，我们的项目相比较官方示例，在模型效果和交互上有一些提升。AR 部分的核心代码一样的。</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/943bfbc4603f46ae9a8ea4e64da150aa~tplv-k3u1fbpfcp-watermark.image?" alt="3.png"></p> <h2 id="难点-or-坑点"><a href="#难点-or-坑点" class="header-anchor">#</a> 难点 or 坑点</h2> <p>（下面的代码都视作伪代码）<br>
scene - 场景；renderer - 渲染器；modelGroup - 模型和模型阴影； light - 灯光；</p> <h3 id="模型效果-阴影等"><a href="#模型效果-阴影等" class="header-anchor">#</a> 模型效果（阴影等）</h3> <ul><li>阴影对象</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 获取模型的边界框</span>
<span class="token keyword">const</span> boundingBox <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Box3</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setFromObject</span><span class="token punctuation">(</span>model<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 定义平面的尺寸和中心点</span>
<span class="token keyword">const</span> planeWidth <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> planeHeight <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>

<span class="token comment">// 计算平面的位置</span>
<span class="token keyword">const</span> planePosition <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Vector3</span><span class="token punctuation">(</span>
  <span class="token punctuation">(</span>boundingBox<span class="token punctuation">.</span>max<span class="token punctuation">.</span>x <span class="token operator">+</span> boundingBox<span class="token punctuation">.</span>min<span class="token punctuation">.</span>x<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span>
  <span class="token operator">-</span><span class="token number">0.05</span><span class="token punctuation">,</span> <span class="token comment">//y的位置固定取值，前提是与模型设计师沟通好，人脚低的位置在y轴0点</span>
  <span class="token punctuation">(</span>boundingBox<span class="token punctuation">.</span>max<span class="token punctuation">.</span>z <span class="token operator">+</span> boundingBox<span class="token punctuation">.</span>min<span class="token punctuation">.</span>z<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 计算平面的旋转角度（与地面平行）</span>
<span class="token keyword">const</span> planeRotation <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Euler</span><span class="token punctuation">(</span><span class="token operator">-</span>Math<span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 创建了一个半径为1、分成32个段的圆形</span>
<span class="token keyword">const</span> geometry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>CircleBufferGeometry</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> material <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>MeshStandardMaterial</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  color<span class="token operator">:</span> <span class="token number">0xffffff</span><span class="token punctuation">,</span>
  transparent<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  opacity<span class="token operator">:</span> <span class="token number">0.1</span><span class="token punctuation">,</span> <span class="token comment">// 透明度不能为0 否则无法接收阴影</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> plane <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>Mesh</span><span class="token punctuation">(</span>geometry<span class="token punctuation">,</span> material<span class="token punctuation">)</span><span class="token punctuation">;</span>
plane<span class="token punctuation">.</span>receiveShadow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
plane<span class="token punctuation">.</span>castShadow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
plane<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>planePosition<span class="token punctuation">)</span><span class="token punctuation">;</span>
plane<span class="token punctuation">.</span>rotation<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>planeRotation<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>render 设置</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>renderer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>WebGLRenderer</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  antialias<span class="token operator">:</span> <span class="token operator">!</span>isIOS<span class="token punctuation">,</span> <span class="token comment">//抗锯齿 IOS需关闭</span>
  alpha<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  shadowMapEnabled<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//使渲染器支持阴影贴图</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
renderer<span class="token punctuation">.</span>shadowMap<span class="token punctuation">.</span>enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
renderer<span class="token punctuation">.</span>shadowMap<span class="token punctuation">.</span>type <span class="token operator">=</span> <span class="token constant">THREE</span><span class="token punctuation">.</span>PCFSoftShadowMap<span class="token punctuation">;</span>
</code></pre></div><ul><li>灯光设置</li></ul> <div class="language-js extra-class"><pre class="language-js"><code>light <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">THREE<span class="token punctuation">.</span>DirectionalLight</span><span class="token punctuation">(</span><span class="token number">0xffffff</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
light<span class="token punctuation">.</span>position<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token operator">-</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//设置灯光位置</span>
scene<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>light<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//添加到场景</span>
light<span class="token punctuation">.</span>castShadow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//设置灯光生成阴影</span>
<span class="token comment">// 设置阴影映射参数</span>
light<span class="token punctuation">.</span>shadow<span class="token punctuation">.</span>mapSize<span class="token punctuation">.</span>width <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
light<span class="token punctuation">.</span>shadow<span class="token punctuation">.</span>mapSize<span class="token punctuation">.</span>height <span class="token operator">=</span> <span class="token number">1024</span> <span class="token operator">*</span> <span class="token number">4</span><span class="token punctuation">;</span>
light<span class="token punctuation">.</span>shadow<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>near <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>
light<span class="token punctuation">.</span>shadow<span class="token punctuation">.</span>camera<span class="token punctuation">.</span>far <span class="token operator">=</span> <span class="token number">80</span><span class="token punctuation">;</span>
light<span class="token punctuation">.</span>shadow<span class="token punctuation">.</span>opacity <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// 设置阴影不透明</span>
</code></pre></div><ul><li>模型上的设置</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">//设置模型生成阴影并接收阴影</span>
model<span class="token punctuation">.</span>castShadow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
model<span class="token punctuation">.</span>receiveShadow <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="向后兼容"><a href="#向后兼容" class="header-anchor">#</a> 向后兼容</h3> <ul><li>由于我们是线下活动，人来人往，对稳定性要求极高，否则模型经常飘走无法完成拍照功能，所以我们需要优先使用 v2。</li> <li>但由于部分手机（比如 iphone13 mini）检测成功率低，总是无法放置模型体验也不好，所以我们做了版本降级的逻辑：当 v2 连续 x 次检测不到时，切换为 v1 版本。</li> <li>对于根本无法支持 AR 功能的情况，我们提供了自拍模式，用相机画面+动态贴图的方式来实现合影。
<blockquote><p>有些手机，系统版本支持，但是硬件不支持，无法通过版本提前预判，只能在创建 AR 会话的回调函数中感知。</p></blockquote></li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">function</span> <span class="token function">compareVersion</span><span class="token punctuation">(</span>targetVersion<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> fn <span class="token operator">=</span> Taro<span class="token punctuation">.</span>getAppBaseInfo <span class="token operator">?</span> Taro<span class="token punctuation">.</span>getAppBaseInfo <span class="token operator">:</span> Taro<span class="token punctuation">.</span>getSystemInfoSync<span class="token punctuation">;</span>
  <span class="token keyword">let</span> cur <span class="token operator">=</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>SDKVersion <span class="token keyword">as</span> <span class="token builtin">string</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> v1 <span class="token operator">=</span> cur<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> v2 <span class="token operator">=</span> targetVersion<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">&quot;.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> len <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>v1<span class="token punctuation">.</span>length<span class="token punctuation">,</span> v2<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">while</span> <span class="token punctuation">(</span>v1<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v1<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>v2<span class="token punctuation">.</span>length <span class="token operator">&lt;</span> len<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    v2<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token string">&quot;0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> num1 <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>v1<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> num2 <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>v2<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>num1 <span class="token operator">&gt;</span> num2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>num1 <span class="token operator">&lt;</span> num2<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">enum</span> VkVersion <span class="token punctuation">{</span>
  <span class="token constant">V0</span> <span class="token operator">=</span> <span class="token string">&quot;v0&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">V1</span> <span class="token operator">=</span> <span class="token string">&quot;v1&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">V2</span> <span class="token operator">=</span> <span class="token string">&quot;v2&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">V2_1</span> <span class="token operator">=</span> <span class="token string">&quot;v2_1&quot;</span><span class="token punctuation">,</span>
  Error <span class="token operator">=</span> <span class="token string">&quot;v_error&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">setSupportVK</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> canUseV<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareVersion</span><span class="token punctuation">(</span><span class="token string">&quot;2.20.0&quot;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;系统版本低，不支持 ar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    canUseV <span class="token operator">=</span> VkVersion<span class="token punctuation">.</span><span class="token constant">V0</span><span class="token punctuation">;</span>
    <span class="token function">showCantArToast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//toast 提示用户不支持 AR</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareVersion</span><span class="token punctuation">(</span><span class="token string">&quot;2.22.0&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> Taro<span class="token punctuation">.</span><span class="token function">isVKSupport</span><span class="token punctuation">(</span>VkVersion<span class="token punctuation">.</span><span class="token constant">V2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">{</span> title<span class="token operator">:</span> <span class="token string">&quot;当前系统支持高版本AR&quot;</span><span class="token punctuation">,</span> icon<span class="token operator">:</span> <span class="token string">&quot;success&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      canUseV <span class="token operator">=</span> VkVersion<span class="token punctuation">.</span><span class="token constant">V2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;系统支持低版本 ar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      canUseV <span class="token operator">=</span> VkVersion<span class="token punctuation">.</span><span class="token constant">V1</span><span class="token punctuation">;</span>
      <span class="token function">showLowVersionModal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//弹窗 提示用户使用低版本或使用自拍</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  Taro<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token constant">VK_STORAGE_KEY</span><span class="token punctuation">,</span> canUseV<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//本地存储</span>
  <span class="token keyword">return</span> canUseV<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">setErrSupportVK</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;微信 api 识别支持，但是创建 ar 失败了&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">showCantArToast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//toast 提示用户不支持 AR</span>
  Taro<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token constant">VK_STORAGE_KEY</span><span class="token punctuation">,</span> VkVersion<span class="token punctuation">.</span>Error<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//本地存储</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="内存问题解决"><a href="#内存问题解决" class="header-anchor">#</a> 内存问题解决</h3> <ul><li>AR 场景</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>session<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  webglBusiness<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  session<span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  session <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li>3d 渲染<br>
three.js 会创建在渲染中所必需的特定对象，这些对象并不会被自动释放；相反，应用程序必须使用特殊的 API 来释放这些资源。<a href="https://threejs.org/docs/index.html#manual/zh/introduction/How-to-dispose-of-objects" target="_blank" rel="noopener noreferrer">官方说明在这里<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>\</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// mesh 释放</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>modelGroup<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  modelGroup<span class="token punctuation">.</span><span class="token function">traverse</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">object</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>object<span class="token punctuation">.</span>isMesh<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> geometry<span class="token punctuation">,</span> material<span class="token punctuation">,</span> skeleton <span class="token punctuation">}</span> <span class="token operator">=</span> object<span class="token punctuation">;</span>
      geometry<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//几何体释放</span>
      material<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//材质释放</span>
      Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>material<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">propName</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> propValue <span class="token operator">=</span> material<span class="token punctuation">[</span>propName<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>propValue <span class="token operator">&amp;&amp;</span> propValue<span class="token punctuation">.</span>isTexture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          propValue<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//纹理释放</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>skeleton <span class="token operator">&amp;&amp;</span> skeleton<span class="token punctuation">.</span>boneTexture<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        skeleton<span class="token punctuation">.</span>boneTexture<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//骨骼纹理释放</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scene<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>modelGroup<span class="token punctuation">)</span><span class="token punctuation">;</span>
  modelGroup <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 灯光阴影</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>light<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  light<span class="token punctuation">.</span>shadow<span class="token punctuation">.</span>map<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scene<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span>light<span class="token punctuation">)</span><span class="token punctuation">;</span>
  light <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 清除场景本身</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>scene<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  scene<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  scene <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// render 释放</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>renderer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  renderer<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  renderer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><blockquote><p>做了以上这些卸载，有一定作用，但是加载模型还是会有内存问题，希望大佬们在评论区给些建议</p></blockquote> <h3 id="重置-平面检测后重新放置模型-与平移"><a href="#重置-平面检测后重新放置模型-与平移" class="header-anchor">#</a> 重置（平面检测后重新放置模型）与平移</h3> <p>开发过程中遇到，重置与平移功能无法完美共存的问题。以手指向左滑动，模型左移为例子来进行下面的说明。</p> <h4 id="问题描述"><a href="#问题描述" class="header-anchor">#</a> 问题描述</h4> <p>相机打开瞬间（朝向正东方）创建了世界坐标系，模型刚好朝着相机，监听 onTouchMove，获取手指滑动距离 dir，调用 model.position.x=model.position.x-dir。模型的表现为向左平移。<br>
当手机姿态发生改变，比如朝向正西方，放置模型。模型会朝着相机，但是手指向左滑动时，模型向右移动。</p> <h4 id="解决方案"><a href="#解决方案" class="header-anchor">#</a> 解决方案</h4> <ul><li>实时计算正确方位</li></ul> <p>拿到相机和模型在 3d 空间的坐标，根据模型与相机的位置关系实时计算模型应该移动的方向。以模型位置指向相机位置的向量为模型的前方，后、左、右依次类推。手指上、下、左、右滑动时，对应的模型平移方向分别为前方，后、左、右。
然后踩坑了，相机和模型拿到的位置坐标永远都是 0 0 0，大无语。</p> <ul><li>反复销毁创建 AR 场景</li></ul> <p>每次放置模型时，都重新创建 AR 场景，创建完立刻执行 hitTest，把模型加到场景中。方向是对了。<br>
但是！销毁创建会导致画面闪烁，并且那些不容易检测的手机再也检测不到平面了。</p> <ul><li>刷新</li></ul> <p>一切重来！对模型数据进行缓存，每次放置模型时都刷新一次页面，重新创建 AR 场景，创建完立刻执行 hitTest。方向肯定是对的啦，也不会画面闪烁。
但那些不容易检测的手机还是再也检测不到平面。</p> <h4 id="最优解-毁灭吧"><a href="#最优解-毁灭吧" class="header-anchor">#</a> 最优解：毁灭吧！</h4></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/knowledge-system/web3d/POLoad/" class="prev">
        web3d性能优化-加载
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/knowledge-system/assets/js/app.714e5304.js" defer></script><script src="/knowledge-system/assets/js/2.7dc4c8b6.js" defer></script><script src="/knowledge-system/assets/js/81.e32e5881.js" defer></script>
  </body>
</html>
