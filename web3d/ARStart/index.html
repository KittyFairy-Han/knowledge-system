<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>VuePress</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="image/logo.png">
    <meta name="description" content="">
    
    <link rel="preload" href="/knowledge-system/assets/css/0.styles.4e160e22.css" as="style"><link rel="preload" href="/knowledge-system/assets/js/app.f8587f51.js" as="script"><link rel="preload" href="/knowledge-system/assets/js/2.23cd175e.js" as="script"><link rel="preload" href="/knowledge-system/assets/js/8.f63ac9af.js" as="script"><link rel="prefetch" href="/knowledge-system/assets/js/10.d76e20ac.js"><link rel="prefetch" href="/knowledge-system/assets/js/11.a096bb3d.js"><link rel="prefetch" href="/knowledge-system/assets/js/12.d668933f.js"><link rel="prefetch" href="/knowledge-system/assets/js/13.90b4e877.js"><link rel="prefetch" href="/knowledge-system/assets/js/14.fd693dc0.js"><link rel="prefetch" href="/knowledge-system/assets/js/15.eb12001c.js"><link rel="prefetch" href="/knowledge-system/assets/js/16.b8839a4f.js"><link rel="prefetch" href="/knowledge-system/assets/js/17.5a61ba3b.js"><link rel="prefetch" href="/knowledge-system/assets/js/18.909693f5.js"><link rel="prefetch" href="/knowledge-system/assets/js/19.88d107b1.js"><link rel="prefetch" href="/knowledge-system/assets/js/20.eed8a9b0.js"><link rel="prefetch" href="/knowledge-system/assets/js/21.e1ad5a0f.js"><link rel="prefetch" href="/knowledge-system/assets/js/22.0840bb42.js"><link rel="prefetch" href="/knowledge-system/assets/js/23.83e030d4.js"><link rel="prefetch" href="/knowledge-system/assets/js/24.f22bcb76.js"><link rel="prefetch" href="/knowledge-system/assets/js/25.cc4f52b8.js"><link rel="prefetch" href="/knowledge-system/assets/js/26.380ef35d.js"><link rel="prefetch" href="/knowledge-system/assets/js/27.3685b59a.js"><link rel="prefetch" href="/knowledge-system/assets/js/28.47001d9a.js"><link rel="prefetch" href="/knowledge-system/assets/js/29.4d8114ad.js"><link rel="prefetch" href="/knowledge-system/assets/js/3.6becfab3.js"><link rel="prefetch" href="/knowledge-system/assets/js/30.4e8cf11a.js"><link rel="prefetch" href="/knowledge-system/assets/js/31.7d98b9ae.js"><link rel="prefetch" href="/knowledge-system/assets/js/32.53037506.js"><link rel="prefetch" href="/knowledge-system/assets/js/33.4e01f4c7.js"><link rel="prefetch" href="/knowledge-system/assets/js/34.4f17c91e.js"><link rel="prefetch" href="/knowledge-system/assets/js/35.73c7efae.js"><link rel="prefetch" href="/knowledge-system/assets/js/36.407635c5.js"><link rel="prefetch" href="/knowledge-system/assets/js/37.3a7b747c.js"><link rel="prefetch" href="/knowledge-system/assets/js/38.8b916dbc.js"><link rel="prefetch" href="/knowledge-system/assets/js/39.68870299.js"><link rel="prefetch" href="/knowledge-system/assets/js/4.72ff6d2a.js"><link rel="prefetch" href="/knowledge-system/assets/js/40.90f3b3cb.js"><link rel="prefetch" href="/knowledge-system/assets/js/41.8ffbb1ed.js"><link rel="prefetch" href="/knowledge-system/assets/js/42.fc848e4c.js"><link rel="prefetch" href="/knowledge-system/assets/js/43.c4f109de.js"><link rel="prefetch" href="/knowledge-system/assets/js/44.c425b5e6.js"><link rel="prefetch" href="/knowledge-system/assets/js/45.26031ee5.js"><link rel="prefetch" href="/knowledge-system/assets/js/46.c1623b4b.js"><link rel="prefetch" href="/knowledge-system/assets/js/47.25291ffe.js"><link rel="prefetch" href="/knowledge-system/assets/js/48.2b55719a.js"><link rel="prefetch" href="/knowledge-system/assets/js/49.61248b8f.js"><link rel="prefetch" href="/knowledge-system/assets/js/5.0c0bb1ac.js"><link rel="prefetch" href="/knowledge-system/assets/js/50.a893be3f.js"><link rel="prefetch" href="/knowledge-system/assets/js/51.e07668b5.js"><link rel="prefetch" href="/knowledge-system/assets/js/52.a4eb1509.js"><link rel="prefetch" href="/knowledge-system/assets/js/53.9b76e387.js"><link rel="prefetch" href="/knowledge-system/assets/js/54.441cdd2f.js"><link rel="prefetch" href="/knowledge-system/assets/js/55.c89e67d7.js"><link rel="prefetch" href="/knowledge-system/assets/js/56.9cb12ff9.js"><link rel="prefetch" href="/knowledge-system/assets/js/57.02b8d3d6.js"><link rel="prefetch" href="/knowledge-system/assets/js/58.e544a614.js"><link rel="prefetch" href="/knowledge-system/assets/js/59.78d1d034.js"><link rel="prefetch" href="/knowledge-system/assets/js/6.7d3f1f43.js"><link rel="prefetch" href="/knowledge-system/assets/js/60.c4614c50.js"><link rel="prefetch" href="/knowledge-system/assets/js/61.d1e64140.js"><link rel="prefetch" href="/knowledge-system/assets/js/62.18e4c1f5.js"><link rel="prefetch" href="/knowledge-system/assets/js/63.82705497.js"><link rel="prefetch" href="/knowledge-system/assets/js/64.34b171dd.js"><link rel="prefetch" href="/knowledge-system/assets/js/65.dff78782.js"><link rel="prefetch" href="/knowledge-system/assets/js/66.5c891979.js"><link rel="prefetch" href="/knowledge-system/assets/js/67.e4aa5c53.js"><link rel="prefetch" href="/knowledge-system/assets/js/68.cd3fb0b9.js"><link rel="prefetch" href="/knowledge-system/assets/js/69.ec47d380.js"><link rel="prefetch" href="/knowledge-system/assets/js/7.1145c0d0.js"><link rel="prefetch" href="/knowledge-system/assets/js/70.654546af.js"><link rel="prefetch" href="/knowledge-system/assets/js/71.c0debf66.js"><link rel="prefetch" href="/knowledge-system/assets/js/72.2753f188.js"><link rel="prefetch" href="/knowledge-system/assets/js/73.c1491318.js"><link rel="prefetch" href="/knowledge-system/assets/js/74.83a64528.js"><link rel="prefetch" href="/knowledge-system/assets/js/75.5575745c.js"><link rel="prefetch" href="/knowledge-system/assets/js/76.39045d26.js"><link rel="prefetch" href="/knowledge-system/assets/js/77.4c537dbc.js"><link rel="prefetch" href="/knowledge-system/assets/js/78.aa2cb08d.js"><link rel="prefetch" href="/knowledge-system/assets/js/79.d940d639.js"><link rel="prefetch" href="/knowledge-system/assets/js/80.06f59ccb.js"><link rel="prefetch" href="/knowledge-system/assets/js/81.5ba294a6.js"><link rel="prefetch" href="/knowledge-system/assets/js/82.9b931bed.js"><link rel="prefetch" href="/knowledge-system/assets/js/83.3e268f75.js"><link rel="prefetch" href="/knowledge-system/assets/js/84.7464fc71.js"><link rel="prefetch" href="/knowledge-system/assets/js/85.07144334.js"><link rel="prefetch" href="/knowledge-system/assets/js/9.f231b4e5.js">
    <link rel="stylesheet" href="/knowledge-system/assets/css/0.styles.4e160e22.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/knowledge-system/" class="home-link router-link-active"></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/knowledge-system/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/knowledge-system/CSS/layout/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/knowledge-system/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/knowledge-system/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/knowledge-system/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/knowledge-system/broswer/work/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/knowledge-system/engineering/" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/knowledge-system/scene/lottieUsage/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/knowledge-system/web3d/" class="nav-link router-link-active">
  web3d
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/knowledge-system/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/knowledge-system/CSS/layout/" class="nav-link">
  CSS
</a></div><div class="nav-item"><a href="/knowledge-system/JS/" class="nav-link">
  JS
</a></div><div class="nav-item"><a href="/knowledge-system/React/" class="nav-link">
  React
</a></div><div class="nav-item"><a href="/knowledge-system/Vue/" class="nav-link">
  Vue
</a></div><div class="nav-item"><a href="/knowledge-system/broswer/work/" class="nav-link">
  浏览器
</a></div><div class="nav-item"><a href="/knowledge-system/engineering/" class="nav-link">
  工程化
</a></div><div class="nav-item"><a href="/knowledge-system/scene/lottieUsage/" class="nav-link">
  其他
</a></div><div class="nav-item"><a href="/knowledge-system/web3d/" class="nav-link router-link-active">
  web3d
</a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/knowledge-system/web3d/demoStart/" class="sidebar-link">3d入门之空间与模型</a></li><li><a href="/knowledge-system/web3d/demoInteraction/" class="sidebar-link">3d入门之交互</a></li><li><a href="/knowledge-system/web3d/PORender/" class="sidebar-link">web3d性能优化-渲染</a></li><li><a href="/knowledge-system/web3d/POLoad/" class="sidebar-link">web3d性能优化-加载</a></li><li><a href="/knowledge-system/web3d/ARStart/" aria-current="page" class="active sidebar-link">入门AR</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#核心技术及相关技术栈" class="sidebar-link">核心技术及相关技术栈</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#🍚-读取" class="sidebar-link">🍚 读取</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#🥬-识别与跟踪" class="sidebar-link">🥬 识别与跟踪</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#🍽️-渲染" class="sidebar-link">🍽️ 渲染</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#🍱-技术方案" class="sidebar-link">🍱 技术方案</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#项目实践" class="sidebar-link">项目实践</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#关键点" class="sidebar-link">关键点：</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#技术方案确定" class="sidebar-link">技术方案确定：</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#微信小程序中的-ar-平面检测能力" class="sidebar-link">微信小程序中的 AR 平面检测能力</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#🪜-难点之向后兼容" class="sidebar-link">🪜 难点之向后兼容</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#原文" class="sidebar-link">原文</a></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#_20230723" class="sidebar-link">20230723</a></li></ul></li><li class="sidebar-sub-header"><a href="/knowledge-system/web3d/ARStart/#其他坑点" class="sidebar-link">其他坑点</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>这篇文章的重点在于需要实现平面检测的 AR 项目选择技术方案的可能性、微信小程序 visiokit 平面检测能力的具体介绍，希望可以帮助大家在前期技术调研上省时省力些。</p> <p>AR 增强现实，是指在真实世界的基础上，通过计算机生成的虚拟信息，将虚拟信息与真实世界进行融合，从而达到增强现实的效果。</p> <h2 id="核心技术及相关技术栈"><a href="#核心技术及相关技术栈" class="header-anchor">#</a> 核心技术及相关技术栈</h2> <p>想要实现 WebAR 效果，四个步骤：读取、识别、跟踪、渲染。<br>
拿扫福举 🌰：
打开相机画面（读取）、扫到福字（识别）、渲染虚拟场景比如小兔子跳出来的动画（渲染）</p> <p><img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/d3f0b5cad4604cb3857b8686ea9d7318~tplv-k3u1fbpfcp-watermark.image?" alt="0.png">
技术上说，粗略流程：</p> <p><img src="https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/c7d806526f704576adc875ac1a41f199~tplv-k3u1fbpfcp-watermark.image?" alt="1.png"></p> <p>技术栈：</p> <p><img src="https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/dd1875af0b6d45e68a5e19c5b62a412d~tplv-k3u1fbpfcp-watermark.image?" alt="5.png"></p> <h3 id="🍚-读取"><a href="#🍚-读取" class="header-anchor">#</a> 🍚 读取</h3> <ul><li><p>浏览器中：WebRTC.js，最关键的 API 方法是 getUserMedia() ，实时获取摄像头的视频流</p></li> <li><p>微信小程序中：腾讯视频云的 liteavsdk</p></li></ul> <blockquote><p><a href="https://developers.weixin.qq.com/community/develop/article/doc/0008ae6f288ee85cb1f7344f35b413" target="_blank" rel="noopener noreferrer">微信官方总结两者区别<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h3 id="🥬-识别与跟踪"><a href="#🥬-识别与跟踪" class="header-anchor">#</a> 🥬 识别与跟踪</h3> <p>浏览器中可用的库 ： JSARToolKit、Tracking.js、jsFeat、js-aruco</p> <ul><li>JSARToolKit（1999 年发布，一直更新至今） 和 js-aruco 都是基于特定的标记去跟踪的，而不能像 Tracking.js 那样进行特征检测。它们依赖于事先印刷好的标记，通过检测标记的位置和方向，从而定位和跟踪物体。在使用这些库时，需要将标记嵌入到需要跟踪的物体上，因此它们更适用于需要定向和固定跟踪的应用场景。</li> <li>Tracking.js 和 jsFeat 等库则使用计算机视觉算法进行特征检测和跟踪，可以在图像中检测和跟踪目标对象，而不需要特定的标记。这些库更适用于需要动态跟踪的场景，例如手势识别、人体识别等应用。不过对于 web 端来说，算力可能跟不上。</li></ul> <p>微信小程序中可用的库：</p> <ul><li>Vision Kit 是一个使用一些深度学习框架 （如 TensorFlow） 进行深度学习的训练和推断，结合一些计算机视觉算法（如 OpenCV），形成的识别追踪库。具备：平面检测、人脸识别、手势识别、跟踪等能力。
<blockquote><p>AR 中最难部分就是跟踪</p></blockquote></li></ul> <h3 id="🍽️-渲染"><a href="#🍽️-渲染" class="header-anchor">#</a> 🍽️ 渲染</h3> <p>浏览器中可用的库：Three.js、Babylon.js、playCanvas、pixi.js(2d)</p> <ul><li><a href="https://threejs.org/" target="_blank" rel="noopener noreferrer">Three.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是最早出现的 WebGL 库之一，提供了丰富的 3D 渲染和动画功能，支持多种 3D 模型格式和材质。</li> <li><a href="https://www.babylonjs.com/" target="_blank" rel="noopener noreferrer">Babylon.js<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 是由微软开发的 3D 游戏引擎，也提供了类似的 3D 渲染和动画功能，并支持物理引擎和多人游戏等高级特性。</li> <li><a href="https://playcanvas.com/" target="_blank" rel="noopener noreferrer">playCanvas<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> 则是一款基于 WebGL 的在线游戏开发平台，提供了完整的游戏开发工具和游戏发布服务，可以方便地在 Web 浏览器中创建和发布高品质的 3D 游戏。</li></ul> <p>微信小程序中可用的库，几乎都是 three 的微信小程序定制版：</p> <ul><li><a href="https://github.com/yannliao/threejs.miniprogram" target="_blank" rel="noopener noreferrer">three.weapp<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/wechat-miniprogram/threejs-miniprogram" target="_blank" rel="noopener noreferrer">threejs-miniprogram<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li><a href="https://github.com/amorwilliams/threejs-wx" target="_blank" rel="noopener noreferrer">threejs-wx<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul> <h3 id="🍱-技术方案"><a href="#🍱-技术方案" class="header-anchor">#</a> 🍱 技术方案</h3> <p>在 web 端（包括小程序）实现完整的 AR 能力，有哪些技术方案呢？</p> <table><thead><tr><th>方案 and 能力</th> <th>特定图像识别</th> <th>特征检测</th> <th>性能</th></tr></thead> <tbody><tr><td>AR.js（WebRTC+JSARToolKit+Three.js/Babylon.js/A-Frame）</td> <td>✔️</td> <td>×</td> <td>✔️</td></tr> <tr><td>WebRTC + trackingJS + ThreeJS</td> <td>✔️</td> <td>✔️</td> <td>×</td></tr> <tr><td>video 标签 + ThreeJS + 陀螺仪</td> <td>×</td> <td>×</td> <td>✔️</td></tr> <tr><td>微信小程序 vision kit + threejs-miniprogram</td> <td>✔️</td> <td>✔️</td> <td>✔️</td></tr> <tr><td>其他小程序</td> <td>？</td> <td>？</td> <td>？</td></tr></tbody></table> <ul><li><p>陀螺仪（伪 AR）<br>
效果类似小程序官方 threedof 示例,demo 路径：交互动画-xframe-总览-AR 能力-ThreeDof AR 相机旋转<br> <img src="https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9d8a80987a5b4a3eb178725931cf2b7a~tplv-k3u1fbpfcp-watermark.image?" alt="小程序demo.png"></p></li> <li><p>特定图像识别（AR.js 官网示例
如左图，二维码就是一个约定好的标记；如右图平放的恐龙图片也是一个约定好的标记。（中间展示的是地理位置识别）。
<img src="https://ar-js-org.github.io/AR.js-Docs/intro-image.gif" alt="特定图像识别"></p></li> <li><p>特征检测
下面会详细介绍平面检测，就不放图啦</p></li></ul> <h2 id="项目实践"><a href="#项目实践" class="header-anchor">#</a> 项目实践</h2> <h3 id="关键点"><a href="#关键点" class="header-anchor">#</a> 关键点：</h3> <ul><li>识别现实世界中的平面，将一个 3D 人物模型“放置”在平面上。</li> <li>可以反复多次识别，重置模型位置。</li> <li>对 3D 模型可进行简单的平移、旋转、缩放操作以便于完成虚拟人物与现实中的人合影。</li></ul> <h4 id="演示"><a href="#演示" class="header-anchor">#</a> 演示</h4> <p><img src="/knowledge-system/assets/img/6.edebca48.jpg" alt="小程序码"> <video src="/knowledge-system/assets/media/7.9b979c57.mp4" width="300px" autoplay="autoplay" controls="controls"></video></p> <h4 id="玩法流程"><a href="#玩法流程" class="header-anchor">#</a> 玩法流程</h4> <p><img src="/knowledge-system/assets/img/8.4b19b7d0.png" alt="流程图"></p> <h3 id="技术方案确定"><a href="#技术方案确定" class="header-anchor">#</a> 技术方案确定：</h3> <p>因为需要 “识别现实世界中的水平面”，也就是说需要特征检测，所以明（wu🤷🏻‍♀️）智（nai🤷‍♂️）の选择了微信小程序，采用 vision kit + threejs-miniprogram 的技术方案。</p> <h2 id="微信小程序中的-ar-平面检测能力"><a href="#微信小程序中的-ar-平面检测能力" class="header-anchor">#</a> 微信小程序中的 AR 平面检测能力</h2> <p>vision kit 有 v1 v2 两个版本，高版本不一定更好哦，下面先介绍一下差异性。
<img src="https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fc2c9e5734044d14a767cc9c15114126~tplv-k3u1fbpfcp-watermark.image?" alt="2.png"></p> <h4 id="⭐️-api-能力"><a href="#⭐️-api-能力" class="header-anchor">#</a> ⭐️ API（能力）</h4> <p>v2 肯定比 v1 多喽～</p> <ul><li>v1 调用 hitTest 进行平面检测。</li> <li>v2 除了 hitTest，还增加了实时监听平面的功能，事件有：'addAnchors'、'updateAnchors'、'removeAnchors'</li> <li>v1 只能检测水平面</li> <li>v2 除了水平面，也可以识别竖平面</li></ul> <h4 id="⚖-稳定性"><a href="#⚖-稳定性" class="header-anchor">#</a> ⚖ 稳定性</h4> <p>v1 版本不如 v2 版本稳定。</p> <ul><li>v1 版本有动态物体从镜头前经过就会把 3D 模型带走，v2 版本不会。</li> <li>但当镜头晃动速率较高的时候，不论哪个版本，模型还是会漂移。</li></ul> <blockquote><p>以上是实践总结，以下是官方说法<br>
V1 版，当手机摄像头没有朝向地面时，3D 模型会漂移、忽大忽小、无法停留在开始的位置。原因是 AR 以地面为跟踪目标，如果地面从手机画面中消失，V1 版 AR 就无法正常运行。<br>
V2 版，AR 以房间环境为跟踪目标，不会因为手机姿态造成 3D 模型漂移。但遮住手机摄像头，V2 版 AR 也无法正常运行。</p></blockquote> <h4 id="✌🏻-准确性与成功率"><a href="#✌🏻-准确性与成功率" class="header-anchor">#</a> ✌🏻 准确性与成功率</h4> <p>v2 检测准确性高于 v1，但成功率低于 v1，具体难度取决于手机。<br>
通过项目实践的经验，个人认为原因是：</p> <ul><li>v2 是真的检测现实中的平面，如果对准的位置是墙，那一定是检测不到的（准确高），但有些手机对准地面可能需要手机放平才检测到（难度高）。</li> <li>v1 之所以容易，是因为 v1 并没有识别现实场景，而是直接去生成一个水平面。所以 v1 几乎每次都成功（难度低），但手机不对着地面的时候，模型会悬空（准确低）。</li></ul> <h4 id="🔌-兼容性"><a href="#🔌-兼容性" class="header-anchor">#</a> 🔌 兼容性</h4> <p>距线上数据统计，<strong>支持 v2 版本的用户 ： 仅支持 v1 版本的用户 ≈ 5 ：1</strong></p> <blockquote><p>官方数据：
<a href="https://zhuanlan.zhihu.com/p/544052686" target="_blank" rel="noopener noreferrer">对微信版本要求、不同手机支持程度<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <h4 id="世界坐标系原点的变化"><a href="#世界坐标系原点的变化" class="header-anchor">#</a> 世界坐标系原点的变化</h4> <ul><li>v1 以识别成功的平面中心点，为世界坐标系原点。也就是说每次 hitTest 世界坐标的原点都更新了。</li> <li>v2 以手机相机的开始位置，为世界坐标系原点。也就是说 createVkSession 运行成功的瞬间，出现相机画面，屏幕中心点为世界坐标原点。后面 hitTest 再也不变了。</li></ul> <h2 id="🪜-难点之向后兼容"><a href="#🪜-难点之向后兼容" class="header-anchor">#</a> 🪜 难点之向后兼容</h2> <p>（下面的代码都视作伪代码）</p> <h3 id="原文"><a href="#原文" class="header-anchor">#</a> 原文</h3> <p>VK_STORAGE_KEY -- 本地存储中代表当前用户使用的平面检测版本<br>
HIT_FAIL_STORAGE_KEY -- 本地存储中代表连续检测失败的次数</p> <h4 id="原则"><a href="#原则" class="header-anchor">#</a> 原则</h4> <ul><li>由于我们是线下活动，人来人往，对稳定性要求极高，否则模型经常飘走无法完成最终的打卡拍照功能，所以我们需要优先使用 v2。</li> <li>但由于部分手机（比如 iphone13 mini）检测成功率低，总是无法放置模型体验也不好，所以我们做了版本降级的逻辑：当 v2 连续第 6 次检测不到时，切换为 v1 版本。</li> <li>对于根本无法支持 AR 功能的情况，我们提供了自拍模式，用相机画面+动态贴图的方式来实现合影。
<blockquote><p>有些手机，系统版本支持，但是硬件不支持，无法通过版本提前预判，只能在创建 AR 会话的回调函数中感知。</p></blockquote></li></ul> <h4 id="兼容逻辑"><a href="#兼容逻辑" class="header-anchor">#</a> 兼容逻辑</h4> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">enum</span> VkVersion <span class="token punctuation">{</span>
  <span class="token constant">V0</span> <span class="token operator">=</span> <span class="token string">&quot;v0&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">V1</span> <span class="token operator">=</span> <span class="token string">&quot;v1&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">V2</span> <span class="token operator">=</span> <span class="token string">&quot;v2&quot;</span><span class="token punctuation">,</span>
  <span class="token constant">V2_1</span> <span class="token operator">=</span> <span class="token string">&quot;v2_1&quot;</span><span class="token punctuation">,</span>
  Error <span class="token operator">=</span> <span class="token string">&quot;v_error&quot;</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
<span class="token keyword">function</span> <span class="token function">setSupportVK</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> canUseV<span class="token punctuation">;</span>
  <span class="token comment">// compareVersion 用来比较 当前微信基础库版本与目标基础库版本，微信官方提供了类似的方法，不写了</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareVersion</span><span class="token punctuation">(</span><span class="token string">&quot;2.20.0&quot;</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//①系统不支持 AR</span>
    canUseV <span class="token operator">=</span> VkVersion<span class="token punctuation">.</span><span class="token constant">V0</span><span class="token punctuation">;</span>
    <span class="token function">showCantArToast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// toast 提示</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">compareVersion</span><span class="token punctuation">(</span><span class="token string">&quot;2.22.0&quot;</span><span class="token punctuation">)</span> <span class="token operator">&gt;=</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> Taro<span class="token punctuation">.</span><span class="token function">isVKSupport</span><span class="token punctuation">(</span>VkVersion<span class="token punctuation">.</span><span class="token constant">V2</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ②系统支持 v2</span>
      canUseV <span class="token operator">=</span> VkVersion<span class="token punctuation">.</span><span class="token constant">V2</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token comment">// ③系统仅支持 V1</span>
      canUseV <span class="token operator">=</span> VkVersion<span class="token punctuation">.</span><span class="token constant">V1</span><span class="token punctuation">;</span>
      <span class="token function">showLowVersionModal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//弹窗 提示用户使用低版本或使用自拍</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  Taro<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token constant">VK_STORAGE_KEY</span><span class="token punctuation">,</span> canUseV<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> canUseV<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// ④系统支持 AR，但设备不支持 AR</span>
<span class="token comment">// session.start 回调 error 时执行这个方法</span>
<span class="token keyword">function</span> <span class="token function">setErrSupportVK</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">showCantArToast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// toast 提示</span>
  Taro<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token constant">VK_STORAGE_KEY</span><span class="token punctuation">,</span> VkVersion<span class="token punctuation">.</span>Error<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 用户在使用过程中，由于检测频繁失败，从 v2 降级到 v1</span>
<span class="token comment">// 每次 session.hitTest 之后都执行这个方法进行记录次数</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">checkUseLowVersion</span> <span class="token operator">=</span> <span class="token punctuation">(</span>success<span class="token operator">:</span> <span class="token builtin">boolean</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hitFailCount <span class="token operator">=</span> <span class="token function">Number</span><span class="token punctuation">(</span>Taro<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span><span class="token constant">HIT_FAIL_STORAGE_KEY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>success<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    Taro<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token constant">HIT_FAIL_STORAGE_KEY</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    Taro<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token constant">HIT_FAIL_STORAGE_KEY</span><span class="token punctuation">,</span> hitFailCount <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hitFailCount <span class="token operator">===</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// ⑤ v2 降级为 v1</span>
      <span class="token function">showLowVersionModal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//降级通知弹窗</span>
      Taro<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span><span class="token constant">VK_STORAGE_KEY</span><span class="token punctuation">,</span> VkVersion<span class="token punctuation">.</span><span class="token constant">V1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>想要更好的体验，只能期待(*❦ω❦)vision kit 和硬件升级 🥺</p> <h3 id="_20230723"><a href="#_20230723" class="header-anchor">#</a> 20230723</h3> <p>除了这个标题下，其他都是 6 月底的原文。项目结束后，针对版本兼容的优化没有停止，有收获！！！所以来补充。<br>
两个思路，（一）是从提高 v2 的检测成功率入手；（二）是从提高 v1 的稳定性入手。虽然无法从根本解决问题，但是通过优化业务流程间接的解决了（一）！那就是实时检测平面，而不是用户点击的时候去检测。</p> <h4 id="流程图对比"><a href="#流程图对比" class="header-anchor">#</a> 流程图对比：</h4> <p><img src="/knowledge-system/assets/img/9.dfc1ba1d.png" alt="对比"></p> <h4 id="效果图比"><a href="#效果图比" class="header-anchor">#</a> 效果图比：</h4> <div><video src="/knowledge-system/assets/media/10.d98e1113.mp4" width="300px" autoplay="autoplay" controls="controls"></video> <video src="/knowledge-system/assets/media/11.a6ee239d.mp4" width="300px" autoplay="autoplay" controls="controls"></video></div> <h4 id="核心代码"><a href="#核心代码" class="header-anchor">#</a> 核心代码</h4> <ul><li>detecting 表示当前是否为重置模式</li> <li>reticle 为光圈对象</li> <li>currentAnchor 用来存储当前变换矩阵的信息</li></ul> <p>代码上的变化就是：</p> <ul><li>每一帧都调用 hitTest。</li> <li>用户点击确认后，不进行 hitTest 而是直接使用 currentAnchor 来为模型做矩阵变换。</li></ul> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// 主渲染函数增加逻辑：</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>detecting <span class="token operator">&amp;&amp;</span> reticle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hitTestRes <span class="token operator">=</span> session<span class="token punctuation">.</span><span class="token function">hitTest</span><span class="token punctuation">(</span><span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token number">0.5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>hitTestRes<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 应用变换的逻辑</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 应用变换的逻辑</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>reticle<span class="token punctuation">.</span>position<span class="token punctuation">.</span>z <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      reticle<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      currentAnchor <span class="token operator">=</span> anchor<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      reticle<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    reticle<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="其他坑点"><a href="#其他坑点" class="header-anchor">#</a> 其他坑点</h2> <p>没有得到完美解决，就当给大家打个预防针吧</p> <ul><li>重置与平移功能不兼容
市面上的小程序也没有重置和平移功能并存的，基本上都是重置+旋转+缩放，可能大家都发现了这个问题吧。在体验的过程中，使用重置功能后，平移方向会不对。正常来说应该在渲染函数中拿到 ar 相机的位置，然后基于它去计算模型的平移，但实际上拿不到正常的 ar 相机位置，目前分析是 vksession 没有这个能力或者是个 bug。</li> <li>内存问题
小程序 AR 普遍存在内存问题，我们的小程序也是，代码层面已经做了 vksession 的卸载，还有 3d 虚拟场景的卸载，但问题仍然没有完全解决。不知道是不是小程序的 three 或者 vksession 本身有内存问题，还有待研究。</li></ul></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/knowledge-system/web3d/POLoad/" class="prev">
        web3d性能优化-加载
      </a></span> <!----></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/knowledge-system/assets/js/app.f8587f51.js" defer></script><script src="/knowledge-system/assets/js/2.23cd175e.js" defer></script><script src="/knowledge-system/assets/js/8.f63ac9af.js" defer></script>
  </body>
</html>
